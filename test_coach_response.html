<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>教练更换响应测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 5px; margin-bottom: 10px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>教练更换响应测试</h1>
        
        <div class="section">
            <h3>用户登录模拟</h3>
            <div class="form-group">
                <label>选择角色:</label>
                <select id="roleSelect">
                    <option value="coach">教练</option>
                    <option value="campus_admin">校区管理员</option>
                </select>
            </div>
            <div class="form-group">
                <label>用户ID:</label>
                <input type="number" id="userIdInput" placeholder="输入用户ID" value="3">
            </div>
            <button onclick="setTestUser()">设置测试用户</button>
        </div>
        
        <div class="section">
            <h3>当前用户信息</h3>
            <div id="currentUser">未设置</div>
        </div>
        
        <div class="section">
            <h3>响应教练更换申请</h3>
            <div class="form-group">
                <label>申请ID:</label>
                <input type="number" id="requestIdInput" placeholder="输入申请ID" value="1">
            </div>
            <div class="form-group">
                <label>响应文本:</label>
                <textarea id="responseText" placeholder="输入响应文本（可选）">同意</textarea>
            </div>
            <button onclick="respondToRequest(true)" style="background-color: #28a745; color: white;">同意申请</button>
            <button onclick="respondToRequest(false)" style="background-color: #dc3545; color: white;">拒绝申请</button>
        </div>
        
        <div class="section">
            <h3>查看当前申请列表</h3>
            <button onclick="loadRequests()">刷新申请列表</button>
            <div id="requestsList">点击刷新加载...</div>
        </div>
        
        <div class="section">
            <h3>操作日志</h3>
            <div id="operationLog" class="log">等待操作...</div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function setTestUser() {
            const role = document.getElementById('roleSelect').value;
            const userId = document.getElementById('userIdInput').value;
            
            const userData = {
                id: parseInt(userId),
                role: role,
                username: `test_${role}_${userId}`
            };
            
            localStorage.setItem('userData', JSON.stringify(userData));
            document.getElementById('currentUser').innerHTML = `
                <strong>ID:</strong> ${userData.id}<br>
                <strong>角色:</strong> ${userData.role}<br>
                <strong>用户名:</strong> ${userData.username}
            `;
            
            log(`设置测试用户: ${JSON.stringify(userData)}`);
        }

        async function respondToRequest(approve) {
            const requestId = document.getElementById('requestIdInput').value;
            const responseText = document.getElementById('responseText').value;
            
            if (!requestId) {
                alert('请输入申请ID');
                return;
            }
            
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            if (!userData.id) {
                alert('请先设置测试用户');
                return;
            }
            
            try {
                log(`开始处理申请 ${requestId}, 用户: ${userData.id}, 操作: ${approve ? '同意' : '拒绝'}`);
                
                const response = await fetch(`/api/coach-change-request/${requestId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        approve: approve,
                        response_text: responseText
                    })
                });
                
                const data = await response.json();
                log(`服务器响应: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    log(`✓ 操作成功: ${data.message}`);
                    // 自动刷新申请列表
                    loadRequests();
                } else {
                    log(`✗ 操作失败: ${data.error}`);
                    if (data.debug) {
                        log(`调试信息: ${JSON.stringify(data.debug)}`);
                    }
                }
                
            } catch (error) {
                log(`✗ 请求失败: ${error.message}`);
            }
        }

        async function loadRequests() {
            try {
                log('正在加载申请列表...');
                
                const response = await fetch('/api/coach-change-requests');
                const data = await response.json();
                
                if (data.success && data.requests) {
                    log(`✓ 加载了 ${data.requests.length} 个申请`);
                    displayRequests(data.requests);
                } else {
                    log(`✗ 加载失败: ${data.error || '未知错误'}`);
                }
                
            } catch (error) {
                log(`✗ 加载申请列表失败: ${error.message}`);
            }
        }

        function displayRequests(requests) {
            if (!requests || requests.length === 0) {
                document.getElementById('requestsList').innerHTML = '<p>暂无申请</p>';
                return;
            }

            const html = `
                <table border="1" cellpadding="5" cellspacing="0" style="width:100%;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>学员</th>
                            <th>当前教练</th>
                            <th>未来教练</th>
                            <th>当前教练响应</th>
                            <th>未来教练响应</th>
                            <th>管理员响应</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${requests.map(req => `
                            <tr>
                                <td>${req.id}</td>
                                <td>${req.student_name}</td>
                                <td>${req.current_coach_name}</td>
                                <td>${req.new_coach_name}</td>
                                <td style="color: ${req.current_coach_response ? (req.current_coach_response === '拒绝' ? 'red' : 'green') : 'gray'}">${req.current_coach_response || '待响应'}</td>
                                <td style="color: ${req.new_coach_response ? (req.new_coach_response === '拒绝' ? 'red' : 'green') : 'gray'}">${req.new_coach_response || '待响应'}</td>
                                <td style="color: ${req.admin_response ? (req.admin_response === '拒绝' ? 'red' : 'green') : 'gray'}">${req.admin_response || '待响应'}</td>
                                <td>${req.status}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('requestsList').innerHTML = html;
        }

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否有存储的用户信息
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            if (userData.id) {
                document.getElementById('currentUser').innerHTML = `
                    <strong>ID:</strong> ${userData.id}<br>
                    <strong>角色:</strong> ${userData.role}<br>
                    <strong>用户名:</strong> ${userData.username}
                `;
                document.getElementById('roleSelect').value = userData.role;
                document.getElementById('userIdInput').value = userData.id;
            }
            
            // 自动加载申请列表
            loadRequests();
        });
    </script>
</body>
</html>