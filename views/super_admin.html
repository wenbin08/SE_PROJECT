<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>超级管理员 - 乒乓球培训管理系统</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    .campus-card {
      transition: all 0.2s;
      border: 1px solid #dee2e6;
    }
    
    .campus-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
    }
    
    .btn-campus {
      background: linear-gradient(45deg, #007bff, #0056b3);
      border: none;
      color: white;
    }
    
    .btn-campus:hover {
      background: linear-gradient(45deg, #0056b3, #003d82);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">
        乒乓球培训管理系统 - 超级管理员
      </a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text mr-3" id="userInfo">超级管理员</span>
        <a class="nav-link" href="/" onclick="logout()">
          退出
        </a>
      </div>
    </nav>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action active" onclick="showCampusManagement()">
            校区管理
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="showSystemStats()">
            系统统计
          </a>
          <a href="/license.html" class="list-group-item list-group-item-action">
            授权管理
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="showUserManagement()">
            用户管理
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="showSystemLogs()">
            系统日志
          </a>
        </div>
      </div>
      
      <div class="col-md-9">
        <!-- 校区管理 -->
        <div id="campusManagement" class="content-section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>校区管理</h4>
            <button class="btn btn-primary" onclick="showAddCampusModal()">
              添加校区
            </button>
          </div>
          
          <div class="row" id="campusList">
            <div class="col-12">
              <div class="alert alert-info">正在加载校区数据...</div>
            </div>
          </div>
        </div>

        <!-- 系统统计 -->
        <div id="systemStats" class="content-section" style="display: none;">
          <h4 class="mb-4">系统统计</h4>
          
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalCampuses">0</h3>
                <p class="mb-0">总校区数</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalUsers">0</h3>
                <p class="mb-0">总用户数</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalCoaches">0</h3>
                <p class="mb-0">教练总数</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalStudents">0</h3>
                <p class="mb-0">学员总数</p>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h5>各校区用户分布</h5>
            </div>
            <div class="card-body">
              <canvas id="campusChart" width="400" height="200"></canvas>
            </div>
          </div>
        </div>

        <!-- 用户管理 -->
        <div id="userManagement" class="content-section" style="display: none;">
          <h4 class="mb-4">全局用户管理</h4>
          
          <div class="card">
            <div class="card-header">
              <div class="row">
                <div class="col-md-6">
                  <h5>用户列表</h5>
                </div>
                <div class="col-md-6">
                  <div class="input-group">
                    <input type="text" class="form-control" id="userSearch" placeholder="搜索用户名、姓名或手机号">
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" onclick="searchUsers()">搜索</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>用户名</th>
                      <th>真实姓名</th>
                      <th>角色</th>
                      <th>校区</th>
                      <th>手机号</th>
                      <th>状态</th>
                      <th>注册时间</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="userTableBody">
                    <tr><td colspan="8" class="text-center">加载中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 系统日志 -->
        <div id="systemLogs" class="content-section" style="display: none;">
          <h4 class="mb-4">系统日志</h4>
          
          <div class="card">
            <div class="card-header">
              <div class="row">
                <div class="col-md-4">
                  <select class="form-control" id="logType">
                    <option value="">所有操作类型</option>
                    <option value="login">用户登录</option>
                    <option value="register">用户注册</option>
                    <option value="coach_select">教练选择</option>
                    <option value="reservation">课程预约</option>
                    <option value="payment">支付操作</option>
                    <option value="tournament">月赛活动</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <input type="date" class="form-control" id="logDate">
                </div>
                <div class="col-md-4">
                  <button class="btn btn-primary" onclick="loadSystemLogs()">查询日志</button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>时间</th>
                      <th>用户</th>
                      <th>操作类型</th>
                      <th>操作内容</th>
                      <th>IP地址</th>
                    </tr>
                  </thead>
                  <tbody id="logTableBody">
                    <tr><td colspan="5" class="text-center">请选择查询条件</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加校区模态框 -->
  <div class="modal fade" id="addCampusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">添加新校区</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="campusForm">
            <div class="form-group">
              <label for="campusName">校区名称 *</label>
              <input type="text" class="form-control" id="campusName" required>
            </div>
            <div class="form-group">
              <label for="campusAddress">校区地址</label>
              <input type="text" class="form-control" id="campusAddress">
            </div>
            <div class="form-group">
              <label for="contactName">联系人</label>
              <input type="text" class="form-control" id="contactName">
            </div>
            <div class="form-group">
              <label for="contactPhone">联系电话</label>
              <input type="text" class="form-control" id="contactPhone">
            </div>
            <div class="form-group">
              <label for="contactEmail">联系邮箱</label>
              <input type="email" class="form-control" id="contactEmail">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="addCampus()">添加校区</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentUser = {};
    let currentSection = 'campusManagement';

    // 页面加载时检查登录状态
    window.onload = function() {
      console.log('=== 超级管理员页面开始初始化 ===');
      
      try {
        // 检查localStorage中的用户数据
        const userDataStr = localStorage.getItem('userData');
        console.log('localStorage中的userData:', userDataStr);
        
        if (!userDataStr) {
          console.log('未找到用户数据，跳转到登录页');
          alert('请先登录超级管理员账户');
          window.location.href = '/';
          return;
        }
        
        currentUser = JSON.parse(userDataStr);
        console.log('解析后的用户数据:', currentUser);
        
        if (!currentUser.id) {
          console.log('用户ID不存在');
          alert('用户数据无效，请重新登录');
          window.location.href = '/';
          return;
        }
        
        if (currentUser.role !== 'super_admin') {
          console.log('用户角色不是super_admin，当前角色:', currentUser.role);
          alert('权限不足，需要超级管理员权限');
          window.location.href = '/';
          return;
        }
        
        console.log('用户验证通过');
        
        // 显示用户信息
        const userInfoElement = document.getElementById('userInfo');
        if (userInfoElement) {
          const displayName = currentUser.real_name || currentUser.username || '超级管理员';
          userInfoElement.textContent = `超级管理员：${displayName}`;
          console.log('用户信息显示完成');
        } else {
          console.error('未找到userInfo元素');
        }
        
        // 确保默认显示校区管理页面
        console.log('开始显示校区管理页面');
        showCampusManagement();
        
        console.log('=== 页面初始化完成 ===');
        
      } catch (error) {
        console.error('页面初始化异常:', error);
        console.error('错误堆栈:', error.stack);
        alert('页面初始化失败: ' + error.message);
      }
    };

    // 显示校区管理
    function showCampusManagement() {
      switchSection('campusManagement');
      loadCampusList();
    }

    // 显示系统统计
    function showSystemStats() {
      switchSection('systemStats');
      loadSystemStats();
    }

    // 显示用户管理
    function showUserManagement() {
      switchSection('userManagement');
      loadAllUsers();
    }

    // 显示系统日志
    function showSystemLogs() {
      switchSection('systemLogs');
    }

    // 切换内容区域
    function switchSection(sectionId) {
      document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
      });
      document.getElementById(sectionId).style.display = 'block';
      
      // 更新导航状态
      document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // 根据sectionId设置对应的导航项为active
      const navItems = document.querySelectorAll('.list-group-item');
      if (sectionId === 'campusManagement' && navItems[0]) navItems[0].classList.add('active');
      else if (sectionId === 'systemStats' && navItems[1]) navItems[1].classList.add('active');
      else if (sectionId === 'userManagement' && navItems[3]) navItems[3].classList.add('active');
      else if (sectionId === 'systemLogs' && navItems[4]) navItems[4].classList.add('active');
      
      currentSection = sectionId;
    }

    // 加载校区列表
    async function loadCampusList() {
      console.log('开始加载校区列表');
      const container = document.getElementById('campusList');
      
      if (!container) {
        console.error('找不到campusList容器');
        return;
      }

      // 显示加载状态
      container.innerHTML = '<div class="col-12"><div class="alert alert-info">正在加载校区数据...</div></div>';
      
      try {
        const response = await fetch('/api/campuses', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        console.log('API响应状态:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const campuses = await response.json();
        console.log('获取到的校区数据:', campuses);
        
        if (!Array.isArray(campuses)) {
          throw new Error('校区数据格式错误');
        }
        
        if (campuses.length === 0) {
          container.innerHTML = '<div class="col-12"><div class="alert alert-info">暂无校区，请添加新校区</div></div>';
          return;
        }
        
        // 渲染校区列表
        const campusCards = campuses.map(campus => `
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title">${campus.name || '未命名校区'}</h5>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown">
                      操作
                    </button>
                    <div class="dropdown-menu">
                      <a class="dropdown-item" href="#" onclick="editCampus(${campus.id})">编辑</a>
                      <a class="dropdown-item text-danger" href="#" onclick="deleteCampus(${campus.id})">删除</a>
                    </div>
                  </div>
                </div>
                <p class="card-text">
                  <strong>地址:</strong> ${campus.address || '未设置地址'}<br>
                  <strong>联系人:</strong> ${campus.contact_name || '未设置联系人'}<br>
                  <strong>电话:</strong> ${campus.contact_phone || '未设置电话'}<br>
                  <strong>邮箱:</strong> ${campus.contact_email || '未设置邮箱'}
                </p>
                <div class="mt-3">
                  <span class="badge badge-primary">ID: ${campus.id}</span>
                  <span class="badge badge-info ml-2">用户数: ${campus.user_count || 0}</span>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = campusCards;
        console.log('校区列表渲染完成，共', campuses.length, '个校区');
        
      } catch (error) {
        console.error('加载校区列表失败:', error);
        container.innerHTML = `<div class="col-12"><div class="alert alert-danger">
          <h6>加载失败</h6>
          <p>错误信息: ${error.message}</p>
          <button class="btn btn-sm btn-outline-danger" onclick="loadCampusList()">重试</button>
        </div></div>`;
      }
    }

    // 加载系统统计
    async function loadSystemStats() {
      console.log('开始加载系统统计');
      try {
        const response = await fetch('/api/super-admin/statistics');
        console.log('统计API响应状态:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const stats = await response.json();
        console.log('获取到的统计数据:', stats);
        
        // 更新统计数字
        const totalCampuses = document.getElementById('totalCampuses');
        const totalUsers = document.getElementById('totalUsers');
        const totalCoaches = document.getElementById('totalCoaches');
        const totalStudents = document.getElementById('totalStudents');
        
        if (totalCampuses) totalCampuses.textContent = stats.total_campuses || 0;
        if (totalUsers) totalUsers.textContent = stats.total_users || 0;
        if (totalCoaches) totalCoaches.textContent = stats.total_coaches || 0;
        if (totalStudents) totalStudents.textContent = stats.total_students || 0;
        
        // 绘制校区分布图表
        if (stats.campus_distribution) {
          drawCampusChart(stats.campus_distribution);
        }
        
        console.log('系统统计加载完成');
        
      } catch (error) {
        console.error('加载系统统计失败:', error);
        // 显示错误状态
        ['totalCampuses', 'totalUsers', 'totalCoaches', 'totalStudents'].forEach(id => {
          const element = document.getElementById(id);
          if (element) element.textContent = 'Error';
        });
      }
    }

    // 绘制校区分布图表
    function drawCampusChart(data) {
      const ctx = document.getElementById('campusChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels || [],
          datasets: [{
            label: '用户数量',
            data: data.values || [],
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // 显示添加校区模态框
    function showAddCampusModal() {
      document.getElementById('campusForm').reset();
      $('#addCampusModal').modal('show');
    }

    // 添加校区
    async function addCampus() {
      const formData = {
        name: document.getElementById('campusName').value.trim(),
        address: document.getElementById('campusAddress').value.trim(),
        contact_name: document.getElementById('contactName').value.trim(),
        contact_phone: document.getElementById('contactPhone').value.trim(),
        contact_email: document.getElementById('contactEmail').value.trim()
      };

      if (!formData.name) {
        alert('请填写校区名称');
        return;
      }

      try {
        const res = await fetch('/api/campuses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await res.json();
        if (!res.ok || !result.success) {
          alert(result.error || '添加校区失败');
          return;
        }

        alert('校区添加成功');
        $('#addCampusModal').modal('hide');
        loadCampusList();

      } catch (error) {
        console.error('Error:', error);
        alert('添加校区失败');
      }
    }

    // 加载所有用户
    async function loadAllUsers() {
      try {
        const res = await fetch('/api/super-admin/users');
        const users = await res.json();
        
        const tbody = document.getElementById('userTableBody');
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无用户数据</td></tr>';
          return;
        }
        
        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.username}</td>
            <td>${user.real_name}</td>
            <td><span class="badge badge-${getRoleBadgeClass(user.role)}">${getRoleText(user.role)}</span></td>
            <td>${user.campus_name || '未分配'}</td>
            <td>${user.phone}</td>
            <td><span class="badge badge-${getStatusBadgeClass(user.status)}">${getStatusText(user.status)}</span></td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="viewUserDetail(${user.id})">查看</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error:', error);
        alert('加载用户列表失败');
      }
    }

    // 辅助函数
    function getRoleText(role) {
      const roleMap = {
        'super_admin': '超级管理员',
        'campus_admin': '校区管理员',
        'student': '学员',
        'coach': '教练'
      };
      return roleMap[role] || role;
    }

    function getRoleBadgeClass(role) {
      const classMap = {
        'super_admin': 'danger',
        'campus_admin': 'warning',
        'student': 'info',
        'coach': 'success'
      };
      return classMap[role] || 'secondary';
    }

    function getStatusText(status) {
      const statusMap = {
        'active': '活跃',
        'pending': '待审核',
        'rejected': '已拒绝'
      };
      return statusMap[status] || status;
    }

    function getStatusBadgeClass(status) {
      const classMap = {
        'active': 'success',
        'pending': 'warning',
        'rejected': 'danger'
      };
      return classMap[status] || 'secondary';
    }

    // 退出登录
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/';
    }
  </script>
</body>
</html>