<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>超级管理员 - 乒乓球培训管理系统</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    .campus-card {
      transition: all 0.2s;
      border: 1px solid #dee2e6;
    }
    
    .campus-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
    }
    
    .btn-campus {
      background: linear-gradient(45deg, #007bff, #0056b3);
      border: none;
      color: white;
    }
    
    .btn-campus:hover {
      background: linear-gradient(45deg, #0056b3, #003d82);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">
        乒乓球培训管理系统 - 超级管理员
      </a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text mr-3" id="userInfo">超级管理员</span>
        <a class="nav-link" href="/" onclick="logout()">
          退出
        </a>
      </div>
    </nav>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action active" onclick="showCampusManagement()">
            校区管理
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="showSystemStats()">
            系统统计
          </a>
          <a href="/license.html" class="list-group-item list-group-item-action">
            授权管理
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="showUserManagement()">
            用户管理
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="showSystemLogs()">
            系统日志
          </a>
        </div>
      </div>
      
      <div class="col-md-9">
        <!-- 校区管理 -->
        <div id="campusManagement" class="content-section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>校区管理</h4>
            <button class="btn btn-primary" onclick="showAddCampusModal()">
              添加校区
            </button>
          </div>
          
          <div class="row" id="campusList">
            <div class="col-12">
              <div class="alert alert-info">正在加载校区数据...</div>
            </div>
          </div>
        </div>

        <!-- 系统统计 -->
        <div id="systemStats" class="content-section" style="display: none;">
          <h4 class="mb-4">系统统计</h4>
          
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalCampuses">0</h3>
                <p class="mb-0">总校区数</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalUsers">0</h3>
                <p class="mb-0">总用户数</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalCoaches">0</h3>
                <p class="mb-0">教练总数</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-card p-3 text-center">
                <h3 id="totalStudents">0</h3>
                <p class="mb-0">学员总数</p>
              </div>
            </div>
          </div>
          


        <!-- 用户管理 -->
        <div id="userManagement" class="content-section" style="display: none;">
          <h4 class="mb-4">全局用户管理</h4>
          
          <div class="card">
            <div class="card-header">
              <div class="row">
                <div class="col-md-6">
                  <h5>用户列表</h5>
                </div>
                <div class="col-md-6">
                  <div class="input-group">
                    <input type="text" class="form-control" id="userSearch" placeholder="搜索用户名、姓名或手机号">
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" onclick="searchUsers()">搜索</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>用户名</th>
                      <th>真实姓名</th>
                      <th>角色</th>
                      <th>校区</th>
                      <th>手机号</th>
                      <th>状态</th>
                      <th>注册时间</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="userTableBody">
                    <tr><td colspan="8" class="text-center">加载中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 系统日志 -->
        <div id="systemLogs" class="content-section" style="display: none;">
          <h4 class="mb-4">系统日志</h4>
          
          <div class="card">
            <div class="card-header">
              <h5 class="mb-3">日志查询条件 <small class="text-muted">（所有条件均为可选，支持任意组合查询）</small></h5>
              
              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">操作类型</label>
                  <select class="form-control" id="logType">
                    <option value="">所有操作类型</option>
                    <option value="user_login">用户登录</option>
                    <option value="login_failed">登录失败</option>
                    <option value="student_register">学员注册</option>
                    <option value="coach_register">教练注册</option>
                    <option value="coach_approve">教练审核</option>
                    <option value="coach_select">教练选择</option>
                    <option value="reservation">课程预约</option>
                    <option value="account_recharge">账户充值</option>
                    <option value="coach_change">教练更换</option>
                    <option value="tournament">月赛活动</option>
                    <option value="user_profile_update">个人信息更新</option>
                    <option value="admin_user">管理员操作</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">日期范围</label>
                  <div class="input-group">
                    <input type="date" class="form-control" id="logDateFrom" placeholder="开始日期">
                    <div class="input-group-append input-group-prepend">
                      <span class="input-group-text">至</span>
                    </div>
                    <input type="date" class="form-control" id="logDateTo" placeholder="结束日期">
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">用户ID或用户名</label>
                  <input type="text" class="form-control" id="logUserId" placeholder="用户ID或用户名（模糊搜索）">
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-12">
                  <div class="btn-group mr-2">
                    <button class="btn btn-primary" onclick="loadSystemLogs()">
                      <i class="fas fa-search"></i> 查询日志
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearLogFilters()">
                      <i class="fas fa-times"></i> 清空条件
                    </button>
                  </div>
                  
                  <div class="btn-group mr-2">
                    <button class="btn btn-info" onclick="loadRecentLogs()">
                      <i class="fas fa-clock"></i> 最近24小时
                    </button>
                    <button class="btn btn-info" onclick="loadTodayLogs()">
                      <i class="fas fa-calendar-day"></i> 今日日志
                    </button>
                    <button class="btn btn-info" onclick="loadWeekLogs()">
                      <i class="fas fa-calendar-week"></i> 本周日志
                    </button>
                  </div>
                  
                  <div class="btn-group">
                    <button class="btn btn-success" onclick="exportLogs()">
                      <i class="fas fa-download"></i> 导出日志
                    </button>
                    <button class="btn btn-warning" onclick="debugAuditLog()">
                      <i class="fas fa-bug"></i> 调试
                    </button>
                    <button class="btn btn-secondary" onclick="addTestLogs()">
                      <i class="fas fa-plus"></i> 添加测试数据
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead class="thead-light">
                    <tr>
                      <th>时间</th>
                      <th>用户</th>
                      <th>操作类型</th>
                      <th>操作详情</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="logTableBody">
                    <tr><td colspan="5" class="text-center text-muted">
                      <i class="fas fa-info-circle"></i> 
                      点击上方的快捷按钮查看日志，或设置查询条件后点击"查询日志"
                    </td></tr>
                  </tbody>
                </table>
              </div>
              
              <!-- 分页控制 -->
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                  <small class="text-muted">显示最近100条记录</small>
                </div>
                <div>
                  <button class="btn btn-outline-primary btn-sm" onclick="loadSystemLogs()">刷新</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加校区模态框 -->
  <div class="modal fade" id="addCampusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">添加新校区</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="campusForm">
            <div class="form-group">
              <label for="campusName">校区名称 *</label>
              <input type="text" class="form-control" id="campusName" required>
            </div>
            <div class="form-group">
              <label for="campusAddress">校区地址</label>
              <input type="text" class="form-control" id="campusAddress">
            </div>
            <div class="form-group">
              <label for="contactName">联系人</label>
              <input type="text" class="form-control" id="contactName">
            </div>
            <div class="form-group">
              <label for="contactPhone">联系电话</label>
              <input type="text" class="form-control" id="contactPhone">
            </div>
            <div class="form-group">
              <label for="contactEmail">联系邮箱</label>
              <input type="email" class="form-control" id="contactEmail">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="addCampus()">添加校区</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="fallback-chart.js"></script>
  <script>
    let currentUser = {};
    let currentSection = 'campusManagement';

    // 页面加载时检查登录状态
    window.onload = function() {
      console.log('=== 超级管理员页面开始初始化 ===');
      
      try {
        // 检查localStorage中的用户数据
        const userDataStr = localStorage.getItem('userData');
        console.log('localStorage中的userData:', userDataStr);
        
        if (!userDataStr) {
          console.log('未找到用户数据，跳转到登录页');
          alert('请先登录超级管理员账户');
          window.location.href = '/';
          return;
        }
        
        currentUser = JSON.parse(userDataStr);
        console.log('解析后的用户数据:', currentUser);
        
        if (!currentUser.id) {
          console.log('用户ID不存在');
          alert('用户数据无效，请重新登录');
          window.location.href = '/';
          return;
        }
        
        if (currentUser.role !== 'super_admin') {
          console.log('用户角色不是super_admin，当前角色:', currentUser.role);
          alert('权限不足，需要超级管理员权限');
          window.location.href = '/';
          return;
        }
        
        console.log('用户验证通过');
        
        // 显示用户信息
        const userInfoElement = document.getElementById('userInfo');
        if (userInfoElement) {
          const displayName = currentUser.real_name || currentUser.username || '超级管理员';
          userInfoElement.textContent = `超级管理员：${displayName}`;
          console.log('用户信息显示完成');
        } else {
          console.error('未找到userInfo元素');
        }
        
        // 确保默认显示校区管理页面
        console.log('开始显示校区管理页面');
        showCampusManagement();
        
        console.log('=== 页面初始化完成 ===');
        
      } catch (error) {
        console.error('页面初始化异常:', error);
        console.error('错误堆栈:', error.stack);
        alert('页面初始化失败: ' + error.message);
      }
    };

    // 显示校区管理
    function showCampusManagement() {
      switchSection('campusManagement');
      loadCampusList();
    }

    // 显示系统统计
    function showSystemStats() {
      switchSection('systemStats');
      loadSystemStats();
    }

    // 显示用户管理
    function showUserManagement() {
      switchSection('userManagement');
      loadAllUsers();
    }

    // 显示系统日志
    function showSystemLogs() {
      switchSection('systemLogs');
      // 默认加载最近24小时的日志
      loadRecentLogs();
    }

    // 切换内容区域
    function switchSection(sectionId) {
      document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
      });
      document.getElementById(sectionId).style.display = 'block';
      
      // 更新导航状态
      document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // 根据sectionId设置对应的导航项为active
      const navItems = document.querySelectorAll('.list-group-item');
      if (sectionId === 'campusManagement' && navItems[0]) navItems[0].classList.add('active');
      else if (sectionId === 'systemStats' && navItems[1]) navItems[1].classList.add('active');
      else if (sectionId === 'userManagement' && navItems[3]) navItems[3].classList.add('active');
      else if (sectionId === 'systemLogs' && navItems[4]) navItems[4].classList.add('active');
      
      currentSection = sectionId;
    }

    // 加载校区列表
    async function loadCampusList() {
      console.log('开始加载校区列表');
      const container = document.getElementById('campusList');
      
      if (!container) {
        console.error('找不到campusList容器');
        return;
      }

      // 显示加载状态
      container.innerHTML = '<div class="col-12"><div class="alert alert-info">正在加载校区数据...</div></div>';
      
      try {
        const response = await fetch('/api/campuses', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        console.log('API响应状态:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const campuses = await response.json();
        console.log('获取到的校区数据:', campuses);
        
        if (!Array.isArray(campuses)) {
          throw new Error('校区数据格式错误');
        }
        
        if (campuses.length === 0) {
          container.innerHTML = '<div class="col-12"><div class="alert alert-info">暂无校区，请添加新校区</div></div>';
          return;
        }
        
        // 渲染校区列表
        const campusCards = campuses.map(campus => `
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title">${campus.name || '未命名校区'}</h5>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown">
                      操作
                    </button>
                    <div class="dropdown-menu">
                      <a class="dropdown-item" href="#" onclick="editCampus(${campus.id})">编辑</a>
                      <a class="dropdown-item text-danger" href="#" onclick="deleteCampus(${campus.id})">删除</a>
                    </div>
                  </div>
                </div>
                <p class="card-text">
                  <strong>地址:</strong> ${campus.address || '未设置地址'}<br>
                  <strong>联系人:</strong> ${campus.contact_name || '未设置联系人'}<br>
                  <strong>电话:</strong> ${campus.contact_phone || '未设置电话'}<br>
                  <strong>邮箱:</strong> ${campus.contact_email || '未设置邮箱'}
                </p>
                <div class="mt-3">
                  <span class="badge badge-primary">ID: ${campus.id}</span>
                  <span class="badge badge-info ml-2">用户数: ${campus.user_count || 0}</span>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = campusCards;
        console.log('校区列表渲染完成，共', campuses.length, '个校区');
        
      } catch (error) {
        console.error('加载校区列表失败:', error);
        container.innerHTML = `<div class="col-12"><div class="alert alert-danger">
          <h6>加载失败</h6>
          <p>错误信息: ${error.message}</p>
          <button class="btn btn-sm btn-outline-danger" onclick="loadCampusList()">重试</button>
        </div></div>`;
      }
    }

    // 加载系统统计
    async function loadSystemStats() {
      console.log('开始加载系统统计');
      
      // 设置加载状态
      ['totalCampuses', 'totalUsers', 'totalCoaches', 'totalStudents'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = '...';
      });
      
      // 重置图表容器
      const chartContainer = document.querySelector('.card-body');
      if (chartContainer) {
        chartContainer.innerHTML = `
          <div class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">加载中...</span>
            </div>
            <p class="mt-2">正在加载图表数据...</p>
          </div>
        `;
      }
      
      // 全局变量重置，避免使用过期的图表实例
      window.campusChart = null;
      
      try {
        console.log('请求系统统计数据...');
        const response = await fetch('/api/super-admin/statistics');
        console.log('统计API响应状态:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API错误响应:', errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const stats = await response.json();
        console.log('获取到的统计数据:', stats);
        
        // 更新统计数字
        const totalCampuses = document.getElementById('totalCampuses');
        const totalUsers = document.getElementById('totalUsers');
        const totalCoaches = document.getElementById('totalCoaches');
        const totalStudents = document.getElementById('totalStudents');
        
        if (totalCampuses) totalCampuses.textContent = stats.total_campuses || 0;
        if (totalUsers) totalUsers.textContent = stats.total_users || 0;
        if (totalCoaches) totalCoaches.textContent = stats.total_coaches || 0;
        if (totalStudents) totalStudents.textContent = stats.total_students || 0;
        
        // 检查并绘制校区分布图表
        if (stats.campus_distribution) {
          console.log('尝试绘制校区图表, 数据:', stats.campus_distribution);
          
          // 准备图表容器
          const chartContainer = document.querySelector('.card-body');
          if (!chartContainer) {
            console.error('找不到图表容器');
            return;
          }
          
          // 重置图表容器，创建新的canvas
          chartContainer.innerHTML = '<canvas id="campusChart" width="400" height="200"></canvas>';
          
          if (!stats.campus_distribution.labels || !stats.campus_distribution.values) {
            console.error('图表数据格式不正确:', stats.campus_distribution);
            chartContainer.innerHTML = '<div class="alert alert-warning">图表数据格式不正确</div>';
          } 
          else if (stats.campus_distribution.labels.length === 0) {
            console.log('没有校区数据可以绘制');
            
            // 显示无数据提示
            chartContainer.innerHTML = '<div class="alert alert-info mt-3">暂无校区数据</div>';
          } 
          else {
            console.log('准备绘制图表，标签数量:', stats.campus_distribution.labels.length);
            console.log('准备绘制图表，数值数量:', stats.campus_distribution.values.length);
            
            // 尝试解决中文编码问题
            const fixedLabels = stats.campus_distribution.labels.map(label => 
              typeof label === 'string' ? label : String(label)
            );
            
            const chartData = {
              labels: fixedLabels,
              values: stats.campus_distribution.values.map(v => Number(v) || 0)
            };
            
            console.log('处理后的图表数据:', chartData);
            drawCampusChart(chartData);
          }
        } else {
          console.error('返回的数据中没有campus_distribution字段');
          const chartContainer = document.querySelector('.card-body');
          if (chartContainer) {
            chartContainer.innerHTML = '<div class="alert alert-danger mt-3">无法获取校区分布数据</div>';
          }
        }
        
        console.log('系统统计加载完成');
        
      } catch (error) {
        console.error('加载系统统计失败:', error);
        
        // 显示错误状态
        ['totalCampuses', 'totalUsers', 'totalCoaches', 'totalStudents'].forEach(id => {
          const element = document.getElementById(id);
          if (element) element.textContent = 'Error';
        });
        
        // 显示图表错误信息
        const canvasContainer = document.querySelector('#campusChart').parentNode;
        if (canvasContainer) {
          canvasContainer.innerHTML = `
            <div class="alert alert-danger mt-3">
              <p>加载统计图表失败</p>
              <small>${error.message}</small>
              <button class="btn btn-sm btn-outline-danger mt-2" onclick="loadSystemStats()">重试</button>
            </div>
          `;
        }
      }
    }

    // 绘制校区分布图表
    function drawCampusChart(data) {
      const canvas = document.getElementById('campusChart');
      if (!canvas) {
        console.error('找不到campusChart画布元素');
        return;
      }
      
      console.log('绘制图表, 数据:', data);
      console.log('labels:', data.labels);
      console.log('values:', data.values);
      
      if (!data || !data.labels || !data.values || !Array.isArray(data.labels) || !Array.isArray(data.values)) {
        console.error('图表数据格式错误:', data);
        return;
      }
      
      if (data.labels.length === 0 || data.values.length === 0) {
        console.log('图表数据为空');
        const chartContainer = canvas.parentNode;
        chartContainer.innerHTML = `
          <div class="alert alert-info mt-3">
            <p>没有可用的校区用户分布数据</p>
          </div>
        `;
        return;
      }
      
      // 确保有一个有效的绘制区域
      const chartContainer = canvas.parentNode;
      chartContainer.innerHTML = ''; // 清除之前的内容
      
      // 创建新的canvas元素
      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'campusChart';
      newCanvas.width = 400;
      newCanvas.height = 200;
      chartContainer.appendChild(newCanvas);
      
      try {
        // 尝试使用Chart.js绘制图表
        console.log('开始创建图表...');
        
        let chartRendered = false;
        
        try {
          const ctx = newCanvas.getContext('2d');
          window.campusChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [{
                label: '用户数量',
                data: data.values,
                backgroundColor: [
                  'rgba(54, 162, 235, 0.8)',
                  'rgba(255, 99, 132, 0.8)',
                  'rgba(75, 192, 192, 0.8)',
                  'rgba(255, 206, 86, 0.8)',
                  'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 99, 132, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'top',
                },
                title: {
                  display: true,
                  text: '校区用户分布'
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
          console.log('Chart.js图表绘制成功');
          chartRendered = true;
        } catch (chartError) {
          console.warn('Chart.js渲染失败，尝试使用备用渲染方法:', chartError);
        }
        
        // 如果Chart.js失败，使用备用方法
        if (!chartRendered) {
          console.log('使用备用图表绘制方法');
          // 检查备用函数是否存在
          if (typeof drawFallbackBarChart === 'function') {
            const rendered = drawFallbackBarChart('campusChart', data.labels, data.values, '校区用户分布');
            if (rendered) {
              console.log('备用图表绘制成功');
              chartRendered = true;
            } else {
              console.error('备用图表绘制失败');
              throw new Error('备用图表绘制失败');
            }
          } else {
            console.error('备用图表函数不可用');
            throw new Error('备用图表函数不可用');
          }
        }
        
      } catch (error) {
        console.error('所有图表绘制方法均失败:', error);
        chartContainer.innerHTML = `
          <div class="alert alert-warning mt-3">
            <p>绘制图表失败</p>
            <small>${error.message}</small>
            <div class="mt-3">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>校区</th>
                    <th>用户数</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.labels.map((label, i) => `
                    <tr>
                      <td>${label}</td>
                      <td>${data.values[i]}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
    }

    // 显示添加校区模态框
    function showAddCampusModal() {
      document.getElementById('campusForm').reset();
      $('#addCampusModal').modal('show');
    }

    // 添加校区
    async function addCampus() {
      const formData = {
        name: document.getElementById('campusName').value.trim(),
        address: document.getElementById('campusAddress').value.trim(),
        contact_name: document.getElementById('contactName').value.trim(),
        contact_phone: document.getElementById('contactPhone').value.trim(),
        contact_email: document.getElementById('contactEmail').value.trim()
      };

      if (!formData.name) {
        alert('请填写校区名称');
        return;
      }

      try {
        const res = await fetch('/api/campuses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await res.json();
        if (!res.ok || !result.success) {
          alert(result.error || '添加校区失败');
          return;
        }

        alert('校区添加成功');
        $('#addCampusModal').modal('hide');
        loadCampusList();

      } catch (error) {
        console.error('Error:', error);
        alert('添加校区失败');
      }
    }

    // 加载所有用户
    async function loadAllUsers() {
      try {
        const res = await fetch('/api/super-admin/users');
        const users = await res.json();
        
        const tbody = document.getElementById('userTableBody');
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无用户数据</td></tr>';
          return;
        }
        
        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.username}</td>
            <td>${user.real_name}</td>
            <td><span class="badge badge-${getRoleBadgeClass(user.role)}">${getRoleText(user.role)}</span></td>
            <td>${user.campus_name || '未分配'}</td>
            <td>${user.phone}</td>
            <td><span class="badge badge-${getStatusBadgeClass(user.status)}">${getStatusText(user.status)}</span></td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="viewUserDetail(${user.id})">查看</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error:', error);
        alert('加载用户列表失败');
      }
    }

    // 辅助函数
    function getRoleText(role) {
      const roleMap = {
        'super_admin': '超级管理员',
        'campus_admin': '校区管理员',
        'student': '学员',
        'coach': '教练'
      };
      return roleMap[role] || role;
    }

    function getRoleBadgeClass(role) {
      const classMap = {
        'super_admin': 'danger',
        'campus_admin': 'warning',
        'student': 'info',
        'coach': 'success'
      };
      return classMap[role] || 'secondary';
    }

    function getStatusText(status) {
      const statusMap = {
        'active': '活跃',
        'pending': '待审核',
        'rejected': '已拒绝'
      };
      return statusMap[status] || status;
    }

    function getStatusBadgeClass(status) {
      const classMap = {
        'active': 'success',
        'pending': 'warning',
        'rejected': 'danger'
      };
      return classMap[status] || 'secondary';
    }

    // 加载系统日志
    async function loadSystemLogs() {
      try {
        const logType = document.getElementById('logType').value;
        const logDateFrom = document.getElementById('logDateFrom').value;
        const logDateTo = document.getElementById('logDateTo').value;
        const logUserId = document.getElementById('logUserId').value;
        
        // 构建查询参数
        const params = new URLSearchParams();
        if (logType) params.append('action', logType);
        
        // 处理日期范围
        if (logDateFrom) {
          params.append('from', logDateFrom + ' 00:00:00');
        }
        if (logDateTo) {
          params.append('to', logDateTo + ' 23:59:59');
        } else if (logDateFrom && !logDateTo) {
          // 如果只设置了开始日期，默认到当天结束
          params.append('to', logDateFrom + ' 23:59:59');
        }
        
        // 处理用户搜索（支持ID或用户名）
        if (logUserId) {
          // 如果是纯数字，当作用户ID处理
          if (/^\d+$/.test(logUserId)) {
            params.append('actor_id', logUserId);
          } else {
            // 否则当作用户名进行模糊搜索
            params.append('username', logUserId);
          }
        }
        
        params.append('limit', '100');
        
        console.log('查询参数:', params.toString());
        window.lastQueryParams = params.toString(); // 保存用于调试
        
        // 首先测试audit_log表状态
        try {
          const testResponse = await fetch('/api/admin/audit-log-test');
          const testData = await testResponse.json();
          console.log('audit_log表状态:', testData);
          
          if (!testData.tableExists) {
            throw new Error('audit_log表不存在，请先运行数据库初始化脚本');
          }
        } catch (testError) {
          console.error('表状态检查失败:', testError);
          window.lastError = testError.message;
        }
        
        const response = await fetch(`/api/admin/audit-log?${params.toString()}`);
        console.log('API响应状态:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API错误响应:', errorText);
          window.lastError = `${response.status} ${response.statusText}: ${errorText}`;
          throw new Error(`查询失败: ${response.status} ${response.statusText}\n详细信息: ${errorText}`);
        }
        
        const logs = await response.json();
        const tbody = document.getElementById('logTableBody');
        
        if (logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">没有找到符合条件的日志记录</td></tr>';
          return;
        }
        
        tbody.innerHTML = logs.map((log, index) => {
          // 解析详细信息
          let details = '无';
          try {
            if (log.details) {
              const parsed = JSON.parse(log.details);
              details = Object.entries(parsed).map(([key, value]) => `${key}: ${value}`).join(', ');
            }
          } catch (e) {
            details = log.details || '无';
          }
          
          // 将日志数据存储在window对象中，避免字符串转义问题
          const logKey = `logData_${index}`;
          window[logKey] = {
            id: log.id,
            action: log.action,
            created_at: log.created_at,
            user_info: log.user_info || '系统',
            details: details
          };
          
          return `
            <tr>
              <td>${new Date(log.created_at).toLocaleString()}</td>
              <td>${log.user_info || '系统'}</td>
              <td><span class="badge badge-primary">${getActionText(log.action)}</span></td>
              <td title="${details.replace(/"/g, '&quot;')}">${details.length > 50 ? details.substring(0, 50) + '...' : details}</td>
              <td>
                <button class="btn btn-sm btn-outline-info" onclick="viewLogDetailSafe('${logKey}')">
                  详情
                </button>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('logTableBody').innerHTML = 
          '<tr><td colspan="5" class="text-center text-danger">加载失败: ' + error.message + '</td></tr>';
      }
    }

    // 清空查询条件
    function clearLogFilters() {
      document.getElementById('logType').value = '';
      document.getElementById('logDateFrom').value = '';
      document.getElementById('logDateTo').value = '';
      document.getElementById('logUserId').value = '';
      
      // 清空后自动加载最近的日志
      loadRecentLogs();
    }

    // 加载最近24小时的日志
    function loadRecentLogs() {
      const now = new Date();
      const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      
      document.getElementById('logType').value = '';
      document.getElementById('logDateFrom').value = yesterday.toISOString().split('T')[0];
      document.getElementById('logDateTo').value = now.toISOString().split('T')[0];
      document.getElementById('logUserId').value = '';
      
      loadSystemLogs();
    }

    // 加载今日日志
    function loadTodayLogs() {
      const today = new Date().toISOString().split('T')[0];
      
      document.getElementById('logType').value = '';
      document.getElementById('logDateFrom').value = today;
      document.getElementById('logDateTo').value = today;
      document.getElementById('logUserId').value = '';
      
      loadSystemLogs();
    }

    // 加载本周日志
    function loadWeekLogs() {
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      document.getElementById('logType').value = '';
      document.getElementById('logDateFrom').value = weekAgo.toISOString().split('T')[0];
      document.getElementById('logDateTo').value = now.toISOString().split('T')[0];
      document.getElementById('logUserId').value = '';
      
      loadSystemLogs();
    }

    // 获取操作类型的中文描述
    function getActionText(action) {
      const actionMap = {
        'user_login': '用户登录',
        'login_failed': '登录失败',
        'student_register': '学员注册',
        'coach_register': '教练注册',
        'coach_approve': '教练审核',
        'coach_select_request': '教练选择申请',
        'coach_select_approve': '教练选择审核',
        'reservation_create': '预约创建',
        'reservation_confirm': '预约确认',
        'reservation_reject': '预约拒绝',
        'reservation_complete': '预约完成',
        'reservation_cancel': '预约取消',
        'review_create': '评价创建',
        'tournament_signup': '月赛报名',
        'tournament_schedule_generate': '月赛排程生成',
        'user_profile_update': '个人信息更新',
        'user_password_change': '密码修改',
        'coach_change_request': '教练更换申请',
        'coach_change_rejected': '教练更换拒绝',
        'coach_change_success': '教练更换成功',
        'account_recharge': '账户充值',
        'license_renew': '许可证续费'
      };
      return actionMap[action] || action;
    }

    // 导出日志
    // 导出日志
    function exportLogs() {
      const logType = document.getElementById('logType').value;
      const logDateFrom = document.getElementById('logDateFrom').value;
      const logDateTo = document.getElementById('logDateTo').value;
      const logUserId = document.getElementById('logUserId').value;
      
      // 构建查询参数
      const params = new URLSearchParams();
      if (logType) params.append('action', logType);
      
      // 处理日期范围
      if (logDateFrom) {
        params.append('from', logDateFrom + ' 00:00:00');
      }
      if (logDateTo) {
        params.append('to', logDateTo + ' 23:59:59');
      } else if (logDateFrom && !logDateTo) {
        // 如果只设置了开始日期，默认到当天结束
        params.append('to', logDateFrom + ' 23:59:59');
      }
      
      // 处理用户搜索
      if (logUserId) {
        if (/^\d+$/.test(logUserId)) {
          params.append('actor_id', logUserId);
        } else {
          params.append('username', logUserId);
        }
      }
      
      params.append('limit', '1000'); // 导出更多数据
      
      // 创建下载链接
      const url = `/api/admin/audit-log?${params.toString()}`;
      window.open(url, '_blank');
    }

    // 调试audit_log
    async function debugAuditLog() {
      try {
        const response = await fetch('/api/admin/audit-log-test');
        const data = await response.json();
        
        const modalContent = `
          <div class="modal fade" id="debugModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Audit Log 调试信息</h5>
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                  <h6>表状态:</h6>
                  <pre>${JSON.stringify(data, null, 2)}</pre>
                  
                  <h6>最近的API调用:</h6>
                  <p>最后查询参数: ${window.lastQueryParams || '无'}</p>
                  <p>最后错误: ${window.lastError || '无'}</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        $('#debugModal').remove();
        $('body').append(modalContent);
        $('#debugModal').modal('show');
        
      } catch (error) {
        alert('调试失败: ' + error.message);
      }
    }

    // 添加测试日志
    async function addTestLogs() {
      try {
        const response = await fetch('/api/admin/add-test-log', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          // 自动刷新日志列表
          loadRecentLogs();
        } else {
          alert('添加失败: ' + (data.error || '未知错误'));
        }
      } catch (error) {
        alert('添加测试日志失败: ' + error.message);
      }
    }

    // 查看日志详情（安全版本）
    function viewLogDetailSafe(logKey) {
      const logData = window[logKey];
      if (!logData) {
        alert('日志数据不存在');
        return;
      }
      
      const modalContent = `
        <div class="modal fade" id="logDetailModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">日志详情</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <table class="table table-borderless">
                  <tr>
                    <th width="120">日志ID:</th>
                    <td>${logData.id}</td>
                  </tr>
                  <tr>
                    <th>操作类型:</th>
                    <td><span class="badge badge-primary">${getActionText(logData.action)}</span></td>
                  </tr>
                  <tr>
                    <th>操作时间:</th>
                    <td>${new Date(logData.created_at).toLocaleString()}</td>
                  </tr>
                  <tr>
                    <th>操作用户:</th>
                    <td>${logData.user_info}</td>
                  </tr>
                  <tr>
                    <th>操作详情:</th>
                    <td><pre style="white-space: pre-wrap; font-size: 12px;">${logData.details}</pre></td>
                  </tr>
                </table>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // 移除旧的模态框
      $('#logDetailModal').remove();
      
      // 添加新的模态框
      $('body').append(modalContent);
      
      // 显示模态框
      $('#logDetailModal').modal('show');
    }

    // 查看日志详情
    function viewLogDetail(id, action, timestamp, actor, details) {
      const decodedDetails = decodeURIComponent(details);
      const modalContent = `
        <div class="modal fade" id="logDetailModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">日志详情</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <table class="table table-borderless">
                  <tr>
                    <th width="120">日志ID:</th>
                    <td>${id}</td>
                  </tr>
                  <tr>
                    <th>操作类型:</th>
                    <td><span class="badge badge-primary">${getActionText(action)}</span></td>
                  </tr>
                  <tr>
                    <th>操作时间:</th>
                    <td>${new Date(timestamp).toLocaleString()}</td>
                  </tr>
                  <tr>
                    <th>操作用户:</th>
                    <td>${actor}</td>
                  </tr>
                  <tr>
                    <th>操作详情:</th>
                    <td><pre style="white-space: pre-wrap; font-size: 12px;">${decodedDetails}</pre></td>
                  </tr>
                </table>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // 移除旧的模态框
      $('#logDetailModal').remove();
      
      // 添加新的模态框
      $('body').append(modalContent);
      
      // 显示模态框
      $('#logDetailModal').modal('show');
    }

    // 退出登录
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/';
    }
  </script>
</body>
</html>