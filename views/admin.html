<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理后台 - 乒乓球培训管理系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <style>
    .sidebar {
      min-height: 100vh;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .sidebar .nav-link {
      color: #333;
      padding: 12px 20px;
      border-radius: 0;
      transition: all 0.3s ease;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background-color: #007bff;
      color: white;
    }
    .sidebar .nav-link i {
      margin-right: 10px;
      width: 20px;
    }
    .main-content {
      padding: 20px;
      background-color: #f8f9fa;
      min-height: 100vh;
    }
    .stats-card {
      border-left: 4px solid #007bff;
      transition: transform 0.2s ease;
    }
    .stats-card:hover {
      transform: translateY(-5px);
    }
    .page-section {
      display: none;
    }
    .page-section.active {
      display: block;
    }
    .quick-action {
      padding: 30px;
      text-align: center;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      color: #6c757d;
    }
    .quick-action:hover {
      border-color: #007bff;
      background-color: #f8f9ff;
      color: #007bff;
      text-decoration: none;
    }
    .quick-action i {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }
  </style>
</head>
<body>
  <!-- 导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-trophy"></i> 乒乓球培训管理系统
      </a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text mr-3">
          欢迎，<span id="adminName">管理员</span>
        </span>
        <a class="nav-link text-light" href="#" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> 退出登录
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- 侧边栏 -->
      <nav class="col-md-2 sidebar bg-white">
        <div class="sidebar-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="bi bi-speedometer2"></i> 仪表盘
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('users')">
                <i class="bi bi-people"></i> 用户管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('coaches')">
                <i class="bi bi-person-badge"></i> 教练管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('reservations')">
                <i class="bi bi-calendar-check"></i> 预约管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('payments')">
                <i class="bi bi-credit-card"></i> 支付管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('messages')">
                <i class="bi bi-chat-dots"></i> 消息管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('tournaments')">
                <i class="bi bi-trophy"></i> 赛事管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/tournament.html" target="_blank">
                <i class="bi bi-calendar-event"></i> 月赛报名
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/license.html" target="_blank">
                <i class="bi bi-shield-check"></i> 软件授权
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('campus')">
                <i class="bi bi-building"></i> 校区管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('settings')">
                <i class="bi bi-gear"></i> 系统设置
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- 主内容区 -->
      <main class="col-md-10 main-content">
        <!-- 仪表盘 -->
        <div id="dashboard" class="page-section active">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
            <h1 class="h2">仪表盘</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <button class="btn btn-outline-secondary btn-sm" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> 刷新数据
              </button>
            </div>
          </div>

          <!-- 统计卡片 -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card stats-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title text-muted">用户总数</h6>
                      <h4 class="text-primary" id="totalUsers">0</h4>
                    </div>
                    <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stats-card" style="border-left-color: #28a745;">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title text-muted">活跃教练</h6>
                      <h4 class="text-success" id="activeCoaches">0</h4>
                    </div>
                    <i class="bi bi-person-badge text-success" style="font-size: 2rem;"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stats-card" style="border-left-color: #ffc107;">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title text-muted">今日预约</h6>
                      <h4 class="text-warning" id="todayReservations">0</h4>
                    </div>
                    <i class="bi bi-calendar-check text-warning" style="font-size: 2rem;"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stats-card" style="border-left-color: #17a2b8;">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title text-muted">今日收入</h6>
                      <h4 class="text-info" id="todayIncome">￥0</h4>
                    </div>
                    <i class="bi bi-wallet2 text-info" style="font-size: 2rem;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 快速操作 -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="mb-3">快速操作</h5>
            </div>
            <div class="col-md-3">
              <a href="/views/admin_approve.html" class="quick-action d-block">
                <i class="bi bi-person-check"></i>
                <strong>教练审核</strong>
                <div class="text-muted">审核待通过的教练申请</div>
              </a>
            </div>
            <div class="col-md-3">
              <a href="/views/payment_admin.html" class="quick-action d-block">
                <i class="bi bi-credit-card"></i>
                <strong>支付管理</strong>
                <div class="text-muted">查看和管理支付记录</div>
              </a>
            </div>
            <div class="col-md-3">
              <a href="/views/recharge.html" class="quick-action d-block">
                <i class="bi bi-wallet2"></i>
                <strong>账户充值</strong>
                <div class="text-muted">为用户账户充值</div>
              </a>
            </div>
            <div class="col-md-3">
              <a href="/views/tournament.html" class="quick-action d-block">
                <i class="bi bi-trophy"></i>
                <strong>赛事管理</strong>
                <div class="text-muted">创建和管理比赛</div>
              </a>
            </div>
          </div>

          <!-- 最新动态 -->
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-clock-history"></i> 最新预约</h6>
                </div>
                <div class="card-body">
                  <div id="recentReservations">
                    <div class="text-center text-muted">加载中...</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> 待处理事项</h6>
                </div>
                <div class="card-body">
                  <div id="pendingTasks">
                    <div class="text-center text-muted">加载中...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 其他页面部分（暂时显示占位内容） -->
        <div id="users" class="page-section">
          <h2>用户管理</h2>
          <p>用户管理功能正在开发中...</p>
        </div>

        <div id="coaches" class="page-section">
          <h2>教练管理</h2>
          <p>教练管理功能正在开发中...</p>
        </div>

        <div id="reservations" class="page-section">
          <h2>预约管理</h2>
          <p>预约管理功能正在开发中...</p>
        </div>

        <div id="payments" class="page-section">
          <h2>支付管理</h2>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            支付管理功能已独立为专门页面，请点击
            <a href="/views/payment_admin.html" class="alert-link">这里</a>
            进入详细的支付管理界面。
          </div>
        </div>

        <div id="messages" class="page-section">
          <h2>消息管理</h2>
          <p>消息管理功能正在开发中...</p>
        </div>

        <div id="tournaments" class="page-section">
          <h2>赛事管理</h2>
          <div class="row">
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h5>月赛报名统计</h5>
                </div>
                <div class="card-body">
                  <div id="tournamentStats">
                    <div class="text-center">
                      <i class="bi bi-trophy" style="font-size: 3rem; color: #ffc107;"></i>
                      <p class="mt-2">加载中...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5>月赛管理</h5>
                  <a href="/tournament.html" class="btn btn-primary btn-sm" target="_blank">
                    <i class="bi bi-calendar-event"></i> 打开月赛管理
                  </a>
                </div>
                <div class="card-body">
                  <p>通过月赛管理页面可以：</p>
                  <ul>
                    <li>查看各组别报名情况</li>
                    <li>管理参赛者列表</li>
                    <li>生成对阵表</li>
                    <li>安排比赛时间和场地</li>
                  </ul>
                  <div class="mt-3">
                    <button class="btn btn-success me-2" onclick="loadTournamentStats()">
                      <i class="bi bi-arrow-clockwise"></i> 刷新统计
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="campus" class="page-section">
          <h2>校区管理</h2>
          <p>校区管理功能正在开发中...</p>
        </div>

        <div id="settings" class="page-section">
          <h2>系统设置</h2>
          <p>系统设置功能正在开发中...</p>
        </div>
      </main>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 检查管理员权限
    function checkAdminAuth() {
      const userData = localStorage.getItem('userData');
      if (!userData) {
        alert('请先登录');
        window.location.href = '/index.html';
        return false;
      }
      
      const user = JSON.parse(userData);
      if (user.role !== 'super_admin' && user.role !== 'campus_admin') {
        alert('权限不足，需要管理员权限');
        window.location.href = '/index.html';
        return false;
      }
      
      document.getElementById('adminName').textContent = user.username || '管理员';
      return true;
    }

    // 显示指定的页面部分
    function showSection(sectionId) {
      // 隐藏所有页面部分
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // 移除所有导航项的active类
      document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // 显示指定页面部分
      document.getElementById(sectionId).classList.add('active');
      
      // 添加对应导航项的active类
      event.target.classList.add('active');
    }

    // 加载仪表盘统计数据
    async function loadDashboardStats() {
      try {
        // 加载用户统计
        const userRes = await fetch('/api/admin/stats/users');
        if (userRes.ok) {
          const userData = await userRes.json();
          document.getElementById('totalUsers').textContent = userData.total || 0;
          document.getElementById('activeCoaches').textContent = userData.activeCoaches || 0;
        }

        // 加载预约统计
        const reservationRes = await fetch('/api/admin/stats/reservations');
        if (reservationRes.ok) {
          const reservationData = await reservationRes.json();
          document.getElementById('todayReservations').textContent = reservationData.today || 0;
        }

        // 加载收入统计
        const paymentRes = await fetch('/api/payment/stats');
        if (paymentRes.ok) {
          const paymentData = await paymentRes.json();
          document.getElementById('todayIncome').textContent = '￥' + (paymentData.todayIncome || 0).toFixed(2);
        }
      } catch (error) {
        console.error('加载统计数据失败:', error);
      }
    }

    // 加载最新预约
    async function loadRecentReservations() {
      try {
        const res = await fetch('/api/admin/reservations/recent?limit=5');
        const data = await res.json();
        
        const container = document.getElementById('recentReservations');
        
        if (!res.ok || !data.reservations || data.reservations.length === 0) {
          container.innerHTML = '<div class="text-muted">暂无最新预约</div>';
          return;
        }

        const html = data.reservations.map(reservation => `
          <div class="border-bottom pb-2 mb-2">
            <div class="d-flex justify-content-between">
              <div>
                <strong>${reservation.student_name}</strong>
                <small class="text-muted d-block">${reservation.coach_name} 教练</small>
              </div>
              <span class="badge badge-${getStatusColor(reservation.status)}">${getStatusText(reservation.status)}</span>
            </div>
            <small class="text-muted">${new Date(reservation.created_at).toLocaleString()}</small>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        document.getElementById('recentReservations').innerHTML = '<div class="text-danger">加载失败</div>';
      }
    }

    // 加载待处理事项
    async function loadPendingTasks() {
      try {
        const res = await fetch('/api/admin/pending-tasks');
        const data = await res.json();
        
        const container = document.getElementById('pendingTasks');
        
        if (!res.ok || !data.tasks || data.tasks.length === 0) {
          container.innerHTML = '<div class="text-muted">暂无待处理事项</div>';
          return;
        }

        const html = data.tasks.map(task => `
          <div class="border-bottom pb-2 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${task.title}</strong>
                <small class="text-muted d-block">${task.description}</small>
              </div>
              <span class="badge badge-warning">${task.count}</span>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        document.getElementById('pendingTasks').innerHTML = '<div class="text-danger">加载失败</div>';
      }
    }

    // 获取状态颜色
    function getStatusColor(status) {
      const colors = {
        'pending': 'warning',
        'confirmed': 'success',
        'completed': 'info',
        'cancelled': 'danger'
      };
      return colors[status] || 'secondary';
    }

    // 获取状态文本
    function getStatusText(status) {
      const texts = {
        'pending': '待确认',
        'confirmed': '已确认',
        'completed': '已完成',
        'cancelled': '已取消'
      };
      return texts[status] || status;
    }

    // 刷新仪表盘
    function refreshDashboard() {
      loadDashboardStats();
      loadRecentReservations();
      loadPendingTasks();
    }

    // 退出登录
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/index.html';
    }

    // 加载月赛统计
    async function loadTournamentStats() {
      try {
        const res = await fetch('/api/tournament/info');
        const data = await res.json();
        
        const container = document.getElementById('tournamentStats');
        
        if (!res.ok) {
          container.innerHTML = `
            <div class="text-center text-danger">
              <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
              <p class="mt-2">加载失败</p>
            </div>
          `;
          return;
        }

        const tournamentDate = new Date(data.tournament_date).toLocaleDateString('zh-CN');
        const deadlineDate = new Date(data.registration_deadline).toLocaleDateString('zh-CN');
        
        container.innerHTML = `
          <div class="text-center mb-3">
            <h5>下次月赛：${tournamentDate}</h5>
            <small class="text-muted">报名截止：${deadlineDate}</small>
          </div>
          <div class="row text-center">
            <div class="col-4">
              <h6 class="text-primary">${data.group_a_count || 0}</h6>
              <small>A组</small>
            </div>
            <div class="col-4">
              <h6 class="text-success">${data.group_b_count || 0}</h6>
              <small>B组</small>
            </div>
            <div class="col-4">
              <h6 class="text-warning">${data.group_c_count || 0}</h6>
              <small>C组</small>
            </div>
          </div>
          <hr>
          <div class="text-center">
            <h4 class="text-info">${data.total_signups || 0}</h4>
            <small>总报名人数</small>
          </div>
        `;
      } catch (error) {
        console.error('加载月赛统计失败:', error);
        document.getElementById('tournamentStats').innerHTML = `
          <div class="text-center text-danger">
            <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
            <p class="mt-2">网络错误</p>
          </div>
        `;
      }
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAdminAuth()) {
        refreshDashboard();
        loadTournamentStats(); // 初始加载月赛统计
      }
    });
  </script>
</body>
</html>
