<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>用户管理 - 校区管理员</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">乒乓球培训管理系统</a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text" id="userInfo">校区管理员</span>
        <a class="nav-link" href="/" onclick="logout()">退出</a>
      </div>
    </nav>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="list-group">
          <a href="/campus_admin.html" class="list-group-item list-group-item-action">管理首页</a>
          <a href="/admin_approve.html" class="list-group-item list-group-item-action">教练审核</a>
          <a href="/admin_users.html" class="list-group-item list-group-item-action active">用户管理</a>
          <a href="/admin_reservations.html" class="list-group-item list-group-item-action">预约管理</a>
          <a href="/admin_finance.html" class="list-group-item list-group-item-action">财务管理</a>
          <a href="/admin_statistics.html" class="list-group-item list-group-item-action">统计报表</a>
        </div>
      </div>
      
      <div class="col-md-9">
        <div class="card">
          <div class="card-header">
            <h5>用户管理</h5>
          </div>
          <div class="card-body">
            <!-- 搜索功能 -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  <label>查询方式：</label>
                  <select id="searchType" class="form-control">
                    <option value="name">姓名</option>
                    <option value="phone">手机号</option>
                    <option value="id_card">身份证号</option>
                    <option value="username">用户名</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label>搜索关键词：</label>
                  <div class="input-group">
                    <input type="text" id="searchKeyword" class="form-control" placeholder="请输入搜索关键词">
                    <div class="input-group-append">
                      <button class="btn btn-primary" onclick="searchUsers()">搜索</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 筛选条件 -->
            <div class="row mb-3">
              <div class="col-md-4">
                <select id="roleFilter" class="form-control" onchange="loadUsers()">
                  <option value="">所有角色</option>
                  <option value="student">学员</option>
                  <option value="coach">教练</option>
                </select>
              </div>
              <div class="col-md-4">
                <select id="statusFilter" class="form-control" onchange="loadUsers()">
                  <option value="">所有状态</option>
                  <option value="active">活跃</option>
                  <option value="inactive">未激活</option>
                  <option value="banned">禁用</option>
                </select>
              </div>
              <div class="col-md-4">
                <button class="btn btn-success" onclick="showAddUserModal()">添加用户</button>
              </div>
            </div>

            <!-- 用户列表 -->
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="thead-dark">
                  <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>真实姓名</th>
                    <th>角色</th>
                    <th>电话</th>
                    <th>邮箱</th>
                    <th>状态</th>
                    <th>注册时间</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="userTableBody">
                  <tr>
                    <td colspan="9" class="text-center">正在加载...</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- 分页 -->
            <nav aria-label="用户列表分页">
              <ul class="pagination justify-content-center" id="pagination">
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加/编辑用户模态框 -->
  <div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">添加用户</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <input type="hidden" id="userId">
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="username">用户名 *</label>
                  <input type="text" class="form-control" id="username" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="password">密码 *</label>
                  <input type="password" class="form-control" id="password" required>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="real_name">真实姓名 *</label>
                  <input type="text" class="form-control" id="real_name" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="role">角色 *</label>
                  <select class="form-control" id="role" required>
                    <option value="student">学员</option>
                    <option value="coach">教练</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="phone">手机号 *</label>
                  <input type="text" class="form-control" id="phone" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="email">邮箱</label>
                  <input type="email" class="form-control" id="email">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="gender">性别</label>
                  <select class="form-control" id="gender">
                    <option value="">请选择</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="age">年龄</label>
                  <input type="number" class="form-control" id="age" min="1" max="120">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="id_card">身份证号</label>
                  <input type="text" class="form-control" id="id_card">
                </div>
              </div>
              <div class="col-md-6" id="coachLevelDiv" style="display: none;">
                <div class="form-group">
                  <label for="coach_level">教练级别</label>
                  <select class="form-control" id="coach_level">
                    <option value="初级">初级教练 (80元/小时)</option>
                    <option value="中级">中级教练 (150元/小时)</option>
                    <option value="高级">高级教练 (200元/小时)</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row" id="coachInfoDiv" style="display: none;">
              <div class="col-12">
                <div class="form-group">
                  <label for="achievements">获奖成绩</label>
                  <textarea class="form-control" id="achievements" rows="3" placeholder="请输入教练的获奖成绩描述"></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    let adminData = {};
    let currentPage = 1;
    let totalPages = 1;
    const pageSize = 10;

    // 页面加载
    window.onload = function() {
      adminData = JSON.parse(localStorage.getItem('userData') || '{}');
      if (!adminData.id || adminData.role !== 'campus_admin') {
        alert('请先登录');
        window.location.href = '/';
        return;
      }
      
      document.getElementById('userInfo').textContent = `校区管理员：${adminData.real_name}`;
      loadUsers();
      
      // 角色选择变化时显示/隐藏教练相关字段
      document.getElementById('role').addEventListener('change', function() {
        const coachFields = document.getElementById('coachLevelDiv');
        const coachInfo = document.getElementById('coachInfoDiv');
        if (this.value === 'coach') {
          coachFields.style.display = 'block';
          coachInfo.style.display = 'block';
        } else {
          coachFields.style.display = 'none';
          coachInfo.style.display = 'none';
        }
      });
    };

    // 加载用户列表
    async function loadUsers() {
      try {
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let url = `/api/admin/users?campus_id=${adminData.campus_id}&page=${currentPage}&limit=${pageSize}`;
        if (role) url += `&role=${role}`;
        if (status) url += `&status=${status}`;
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          throw new Error(data.error || '加载失败');
        }
        
        displayUsers(data.users);
        updatePagination(data.total);
      } catch (error) {
        console.error('加载用户失败:', error);
        document.getElementById('userTableBody').innerHTML = 
          '<tr><td colspan="9" class="text-center text-danger">加载失败</td></tr>';
      }
    }

    // 搜索用户
    async function searchUsers() {
      const type = document.getElementById('searchType').value;
      const keyword = document.getElementById('searchKeyword').value.trim();
      
      if (!keyword) {
        alert('请输入搜索关键词');
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/users/search?campus_id=${adminData.campus_id}&type=${type}&keyword=${encodeURIComponent(keyword)}`);
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          throw new Error(data.error || '搜索失败');
        }
        
        displayUsers(data.users);
        // 隐藏分页
        document.getElementById('pagination').innerHTML = '';
      } catch (error) {
        console.error('搜索失败:', error);
        alert('搜索失败：' + error.message);
      }
    }

    // 显示用户列表
    function displayUsers(users) {
      const tbody = document.getElementById('userTableBody');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">暂无数据</td></tr>';
        return;
      }
      
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.id}</td>
          <td>${user.username}</td>
          <td>${user.real_name}</td>
          <td>
            <span class="badge badge-${user.role === 'student' ? 'primary' : 'success'}">
              ${user.role === 'student' ? '学员' : '教练'}
            </span>
            ${user.coach_level ? `<br><small class="text-muted">${user.coach_level}</small>` : ''}
          </td>
          <td>${user.phone || '-'}</td>
          <td>${user.email || '-'}</td>
          <td>
            <span class="badge badge-${getStatusBadge(user.status)}">
              ${getStatusText(user.status)}
            </span>
          </td>
          <td>${new Date(user.created_at).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">编辑</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.real_name}')">删除</button>
            ${user.status === 'active' ? 
              `<button class="btn btn-sm btn-outline-warning" onclick="toggleUserStatus(${user.id}, 'banned')">禁用</button>` :
              `<button class="btn btn-sm btn-outline-success" onclick="toggleUserStatus(${user.id}, 'active')">启用</button>`
            }
          </td>
        </tr>
      `).join('');
    }

    // 获取状态徽章样式
    function getStatusBadge(status) {
      switch(status) {
        case 'active': return 'success';
        case 'inactive': return 'secondary';
        case 'banned': return 'danger';
        default: return 'light';
      }
    }

    // 获取状态文本
    function getStatusText(status) {
      switch(status) {
        case 'active': return '活跃';
        case 'inactive': return '未激活';
        case 'banned': return '已禁用';
        default: return '未知';
      }
    }

    // 更新分页
    function updatePagination(total) {
      totalPages = Math.ceil(total / pageSize);
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let paginationHtml = '';
      
      // 上一页
      paginationHtml += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
        </li>
      `;
      
      // 页码
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          paginationHtml += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
              <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
          `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
      }
      
      // 下一页
      paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
        </li>
      `;
      
      pagination.innerHTML = paginationHtml;
    }

    // 切换页面
    function changePage(page) {
      if (page < 1 || page > totalPages || page === currentPage) return;
      currentPage = page;
      loadUsers();
    }

    // 显示添加用户模态框
    function showAddUserModal() {
      document.getElementById('modalTitle').textContent = '添加用户';
      document.getElementById('userForm').reset();
      document.getElementById('userId').value = '';
      document.getElementById('password').required = true;
      document.getElementById('coachLevelDiv').style.display = 'none';
      document.getElementById('coachInfoDiv').style.display = 'none';
      $('#userModal').modal('show');
    }

    // 编辑用户
    async function editUser(id) {
      try {
        const res = await fetch(`/api/admin/user/${id}`);
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          throw new Error(data.error || '获取用户信息失败');
        }
        
        const user = data.user;
        
        document.getElementById('modalTitle').textContent = '编辑用户';
        document.getElementById('userId').value = user.id;
        document.getElementById('username').value = user.username;
        document.getElementById('password').value = '';
        document.getElementById('password').required = false;
        document.getElementById('real_name').value = user.real_name;
        document.getElementById('role').value = user.role;
        document.getElementById('phone').value = user.phone || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('gender').value = user.gender || '';
        document.getElementById('age').value = user.age || '';
        document.getElementById('id_card').value = user.id_card || '';
        document.getElementById('coach_level').value = user.coach_level || '初级';
        document.getElementById('achievements').value = user.achievements || '';
        
        // 显示/隐藏教练字段
        if (user.role === 'coach') {
          document.getElementById('coachLevelDiv').style.display = 'block';
          document.getElementById('coachInfoDiv').style.display = 'block';
        }
        
        $('#userModal').modal('show');
      } catch (error) {
        alert('编辑失败：' + error.message);
      }
    }

    // 保存用户
    async function saveUser() {
      const userId = document.getElementById('userId').value;
      const isEdit = !!userId;
      
      const userData = {
        username: document.getElementById('username').value.trim(),
        real_name: document.getElementById('real_name').value.trim(),
        role: document.getElementById('role').value,
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        gender: document.getElementById('gender').value,
        age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null,
        id_card: document.getElementById('id_card').value.trim(),
        campus_id: adminData.campus_id
      };
      
      // 密码处理
      const password = document.getElementById('password').value;
      if (!isEdit || password) {
        userData.password = password;
      }
      
      // 教练相关字段
      if (userData.role === 'coach') {
        userData.coach_level = document.getElementById('coach_level').value;
        userData.achievements = document.getElementById('achievements').value.trim();
      }
      
      // 验证必填字段
      if (!userData.username || !userData.real_name || !userData.phone) {
        alert('请填写所有必填字段');
        return;
      }
      
      try {
        const url = isEdit ? `/api/admin/user/${userId}` : '/api/admin/user';
        const method = isEdit ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          throw new Error(data.error || '保存失败');
        }
        
        alert(isEdit ? '用户信息更新成功' : '用户添加成功');
        $('#userModal').modal('hide');
        loadUsers();
      } catch (error) {
        alert('保存失败：' + error.message);
      }
    }

    // 删除用户
    async function deleteUser(id, name) {
      if (!confirm(`确定要删除用户 "${name}" 吗？此操作不可撤销！`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/user/${id}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          throw new Error(data.error || '删除失败');
        }
        
        alert('用户删除成功');
        loadUsers();
      } catch (error) {
        alert('删除失败：' + error.message);
      }
    }

    // 切换用户状态
    async function toggleUserStatus(id, status) {
      const statusText = status === 'active' ? '启用' : '禁用';
      
      if (!confirm(`确定要${statusText}该用户吗？`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/user/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: status })
        });
        
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          throw new Error(data.error || '操作失败');
        }
        
        alert(`用户${statusText}成功`);
        loadUsers();
      } catch (error) {
        alert('操作失败：' + error.message);
      }
    }

    // 退出登录
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/';
    }
  </script>
</body>
</html>