<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>课程预约 - 乒乓球培训管理系统</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="/css/student.css">
</head>
<body>
  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">乒乓球培训管理系统</a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text" id="userInfo">学员</span>
        <a class="nav-link" href="/" onclick="logout()">退出</a>
      </div>
    </nav>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="list-group">
          <a href="/student.html" class="list-group-item list-group-item-action">学员首页</a>
          <a href="/coach_select.html" class="list-group-item list-group-item-action">选择教练</a>
          <a href="/student_reservation.html" class="list-group-item list-group-item-action active">课程预约</a>
          <a href="/recharge.html" class="list-group-item list-group-item-action">账户充值</a>
          <a href="/reviews.html" class="list-group-item list-group-item-action">课后评价</a>
          <a href="/tournament.html" class="list-group-item list-group-item-action">月赛报名</a>
          <a href="/messages.html" class="list-group-item list-group-item-action">系统消息</a>
        </div>
        
        <!-- 账户余额显示 -->
        <div class="card mt-3">
          <div class="card-header">
            <h6>账户余额</h6>
          </div>
          <div class="card-body text-center">
            <h4 class="text-success" id="accountBalance">￥0.00</h4>
            <a href="/recharge.html" class="btn btn-sm btn-outline-primary">充值</a>
          </div>
        </div>
        
        <!-- 取消次数限制 -->
        <div class="card mt-3">
          <div class="card-header">
            <h6>本月取消配额</h6>
          </div>
          <div class="card-body">
            <div id="cancelQuota">加载中...</div>
          </div>
        </div>
      </div>
      
      <div class="col-md-9">
        <!-- 创建预约 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>创建新预约</h5>
          </div>
          <div class="card-body">
            <form id="reservationForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>选择教练</label>
                    <select class="form-control" id="coachSelect" onchange="onCoachChange()">
                      <option value="">请选择教练</option>
                    </select>
                    <small class="text-muted">只能选择已建立双选关系的教练</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>校区</label>
                    <input type="text" class="form-control" id="campusName" readonly>
                    <input type="hidden" id="campusId">
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>开始时间</label>
                    <input type="datetime-local" class="form-control" id="startTime" onchange="onTimeChange()">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>结束时间</label>
                    <input type="datetime-local" class="form-control" id="endTime" onchange="onTimeChange()">
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>球台选择</label>
                    <select class="form-control" id="tableSelect">
                      <option value="">自动分配</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-outline-info mt-2" onclick="loadAvailableTables()">
                      查询可用球台
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>预计费用</label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text">￥</span>
                      </div>
                      <input type="text" class="form-control" id="estimatedCost" readonly>
                    </div>
                    <small class="text-muted">实际费用以教练确认时为准</small>
                  </div>
                </div>
              </div>
              
              <button type="submit" class="btn btn-primary">提交预约</button>
            </form>
          </div>
        </div>

        <!-- 教练课表 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>教练课表（未来7天）</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="loadCoachSchedule()">刷新</button>
          </div>
          <div class="card-body">
            <div id="scheduleContent">请先选择教练</div>
          </div>
        </div>

        <!-- 我的预约 -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>我的预约</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadMyReservations('all')">
              <i class="fas fa-sync-alt"></i> 刷新
            </button>
          </div>
          <div class="card-body pb-0">
            <div class="btn-group btn-group-sm mb-3" role="group">
              <button type="button" class="btn btn-outline-primary active" onclick="loadMyReservations('all')">全部</button>
              <button type="button" class="btn btn-outline-primary" onclick="loadMyReservations('pending')">待确认</button>
              <button type="button" class="btn btn-outline-primary" onclick="loadMyReservations('confirmed')">已确认</button>
              <button type="button" class="btn btn-outline-primary" onclick="loadMyReservations('completed')">已完成</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>预约ID</th>
                    <th>教练</th>
                    <th>时间</th>
                    <th>球台</th>
                    <th>状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="myReservationsList">
                  <tr><td colspan="6" class="text-center">加载中...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    let studentData = {};
    let selectedCoachData = null;
    
    async function loadAccountBalance() {
      try {
        const res = await fetch(`/api/account/${studentData.id}`);
        const account = await res.json();
        document.getElementById('accountBalance').textContent = `￥${account.balance || 0}`;
      } catch (error) {
        document.getElementById('accountBalance').textContent = '￥0.00';
      }
    }
    
    async function loadCancelQuota() {
      try {
        const res = await fetch(`/api/reservations/cancel/quota?by=student&actor_id=${studentData.id}`);
        const quota = await res.json();
        document.getElementById('cancelQuota').innerHTML = `
          <div class="text-center">
            <div class="progress mb-2">
              <div class="progress-bar" style="width: ${(quota.used / quota.total) * 100}%"></div>
            </div>
            <small>已使用 ${quota.used}/${quota.total} 次</small>
          </div>
        `;
      } catch (error) {
        document.getElementById('cancelQuota').innerHTML = '<small class="text-danger">加载失败</small>';
      }
    }
    
    async function loadApprovedCoaches() {
      try {
        const res = await fetch(`/api/student/approved-coaches?student_id=${studentData.id}`);
        const coaches = await res.json();
        
        const select = document.getElementById('coachSelect');
        select.innerHTML = '<option value="">请选择教练</option>';
        
        if (coaches.length === 0) {
          select.innerHTML = '<option value="">请先选择教练建立双选关系</option>';
          return;
        }
        
        coaches.forEach(coach => {
          const option = document.createElement('option');
          option.value = coach.id;
          option.textContent = `${coach.real_name} (￥${coach.hourly_fee}/小时)`;
          option.dataset.hourlyFee = coach.hourly_fee;
          option.dataset.campusId = coach.campus_id;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('加载教练失败:', error);
      }
    }
    
    async function onCoachChange() {
      const select = document.getElementById('coachSelect');
      const selectedOption = select.options[select.selectedIndex];
      
      if (!selectedOption.value) {
        selectedCoachData = null;
        document.getElementById('campusName').value = '';
        document.getElementById('campusId').value = '';
        document.getElementById('scheduleContent').innerHTML = '请先选择教练';
        return;
      }
      
      selectedCoachData = {
        id: selectedOption.value,
        hourly_fee: parseFloat(selectedOption.dataset.hourlyFee || 0),
        campus_id: selectedOption.dataset.campusId
      };
      
      // 获取校区信息
      try {
        const res = await fetch('/api/campuses');
        const campuses = await res.json();
        const campus = campuses.find(c => c.id == selectedCoachData.campus_id);
        document.getElementById('campusName').value = campus ? campus.name : '未知校区';
        document.getElementById('campusId').value = selectedCoachData.campus_id;
      } catch (error) {
        document.getElementById('campusName').value = '加载失败';
      }
      
      loadCoachSchedule();
      onTimeChange();
    }
    
    function onTimeChange() {
      if (!selectedCoachData) return;
      
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      
      if (startTime && endTime) {
        const start = new Date(startTime);
        const end = new Date(endTime);
        const duration = (end - start) / (1000 * 60 * 60); // 小时
        
        if (duration > 0) {
          const cost = duration * selectedCoachData.hourly_fee;
          document.getElementById('estimatedCost').value = cost.toFixed(2);
        } else {
          document.getElementById('estimatedCost').value = '0.00';
        }
      }
    }
    
    async function loadCoachSchedule() {
      if (!selectedCoachData) return;
      
      try {
        const from = new Date();
        const to = new Date(Date.now() + 7 * 24 * 3600 * 1000);
        const res = await fetch(`/api/coach/schedule?coach_id=${selectedCoachData.id}&from=${from.toISOString()}&to=${to.toISOString()}`);
        const schedule = await res.json();
        
        const container = document.getElementById('scheduleContent');
        if (schedule.length === 0) {
          container.innerHTML = '<p class="text-muted">教练未来7天暂无安排</p>';
        } else {
          container.innerHTML = `
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>时间</th>
                    <th>球台</th>
                    <th>状态</th>
                  </tr>
                </thead>
                <tbody>
                  ${schedule.map(item => `
                    <tr>
                      <td>${new Date(item.start_time).toLocaleDateString()}</td>
                      <td>${new Date(item.start_time).toLocaleTimeString()} - ${new Date(item.end_time).toLocaleTimeString()}</td>
                      <td>${item.table_code || '-'}</td>
                      <td>${getStatusBadge(item.status)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('scheduleContent').innerHTML = '<p class="text-danger">加载失败</p>';
      }
    }
    
    async function loadAvailableTables() {
      const campusId = document.getElementById('campusId').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      
      if (!campusId || !startTime || !endTime) {
        alert('请先选择教练和时间');
        return;
      }
      
      try {
        const res = await fetch(`/api/tables/available?campus_id=${campusId}&start=${encodeURIComponent(startTime)}&end=${encodeURIComponent(endTime)}`);
        const tables = await res.json();
        
        const select = document.getElementById('tableSelect');
        select.innerHTML = '<option value="">自动分配</option>';
        
        if (tables.length === 0) {
          select.innerHTML = '<option value="">该时段无可用球台</option>';
        } else {
          tables.forEach(table => {
            const option = document.createElement('option');
            option.value = table.id;
            option.textContent = `球台 ${table.code}`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        alert('查询球台失败');
      }
    }
    
    async function createReservation() {
      if (!selectedCoachData) {
        alert('请先选择教练');
        return;
      }
      
      const campusId = document.getElementById('campusId').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const tableId = document.getElementById('tableSelect').value;
      
      if (!startTime || !endTime) {
        alert('请选择开始和结束时间');
        return;
      }
      
      const start = new Date(startTime);
      const end = new Date(endTime);
      
      if (end <= start) {
        alert('结束时间必须晚于开始时间');
        return;
      }
      
      // 检查是否至少提前1小时预约
      const now = new Date();
      if (start <= new Date(now.getTime() + 60 * 60 * 1000)) {
        alert('请至少提前1小时预约');
        return;
      }
      
      try {
        const payload = {
          campus_id: parseInt(campusId),
          coach_id: parseInt(selectedCoachData.id),
          student_id: studentData.id,
          start_time: startTime,
          end_time: endTime
        };
        
        if (tableId) {
          payload.table_id = parseInt(tableId);
        }
        
        const res = await fetch('/api/reservations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.error || '预约失败');
          return;
        }
        
        alert(`预约创建成功！\n预约ID: ${data.reservation_id}\n球台: ${data.table_id}\n请等待教练确认`);
        
        // 清空表单
        document.getElementById('reservationForm').reset();
        document.getElementById('estimatedCost').value = '';
        
        // 刷新数据
        loadCoachSchedule();
        loadMyReservations('all');
        loadAccountBalance();
      } catch (error) {
        alert('预约失败，请稍后重试');
      }
    }
    
    async function loadMyReservations(status = 'all') {
      try {
        if (!studentData || !studentData.id) {
          console.error('学员ID为空，无法加载预约');
          document.getElementById('myReservationsList').innerHTML = '<tr><td colspan="6" class="text-center text-warning">学员信息未加载，请刷新页面</td></tr>';
          return;
        }
        
        let url = `/api/reservations?student_id=${studentData.id}`;
        if (status !== 'all') {
          url += `&status=${status}`;
        }
        
        console.log('请求预约数据:', url);
        const res = await fetch(url);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('API返回错误状态:', res.status, errorText);
          document.getElementById('myReservationsList').innerHTML = `<tr><td colspan="6" class="text-center text-danger">API错误: ${res.status}</td></tr>`;
          return;
        }
        
        const reservations = await res.json();
        console.log('获取到预约数据:', reservations);
        
        const tbody = document.getElementById('myReservationsList');
        if (!Array.isArray(reservations)) {
          console.error('返回的数据不是数组:', reservations);
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">数据格式错误</td></tr>';
          return;
        }
        
        if (reservations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无预约记录</td></tr>';
          return;
        }
        
        tbody.innerHTML = reservations.map(res => {
          let statusDisplay = getStatusBadge(res.status);
          
          // 如果有待处理的取消请求，在状态旁显示额外信息
          if (res.cancel_request_by && res.cancel_request_by !== 'none' && res.status !== 'canceled') {
            const requestBy = res.cancel_request_by === 'student' ? '您发起' : '教练发起';
            statusDisplay += ` <span class="badge badge-info">取消申请中(${requestBy})</span>`;
          }
          
          return `
          <tr>
            <td>${res.id}</td>
            <td>${res.coach_name || '未知'}</td>
            <td>${new Date(res.start_time).toLocaleString()}</td>
            <td>${res.table_code || '-'}</td>
            <td>${statusDisplay}</td>
            <td>${getActionButtons(res)}</td>
          </tr>
        `}).join('');
        
        // 更新按钮状态
        if (typeof event !== 'undefined' && event.target) {
          document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
          });
          event.target.classList.add('active');
        }
      } catch (error) {
        console.error('加载预约失败:', error);
        document.getElementById('myReservationsList').innerHTML = `<tr><td colspan="6" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
      }
    }
    
    function getStatusBadge(status) {
      const badges = {
        'pending': '<span class="badge badge-warning">待确认</span>',
        'confirmed': '<span class="badge badge-success">已确认</span>',
        'rejected': '<span class="badge badge-danger">已拒绝</span>',
        'canceled': '<span class="badge badge-secondary">已取消</span>',
        'completed': '<span class="badge badge-info">已完成</span>'
      };
      return badges[status] || status;
    }
    
    function getActionButtons(reservation) {
      // 预约状态为待确认或已确认时才可能显示取消按钮
      if (reservation.status === 'confirmed' || reservation.status === 'pending') {
        const now = new Date();
        const startTime = new Date(reservation.start_time);
        const timeDiff = startTime - now;
        
        // 距开始时间24小时以上才能取消
        if (timeDiff > 24 * 3600 * 1000) {
          // 如果已经有取消请求，并且不是学生发起的，则显示"确认取消"按钮
          if (reservation.cancel_request_by === 'coach') {
            return `<button class="btn btn-sm btn-danger" onclick="confirmCancelReservation(${reservation.id})">确认取消</button>`;
          } 
          // 如果是学生自己发起的取消，则显示"等待确认"
          else if (reservation.cancel_request_by === 'student') {
            return `<span class="badge badge-info">等待教练确认取消</span>`;
          }
          // 否则显示正常取消按钮
          else {
            return `<button class="btn btn-sm btn-warning" onclick="cancelReservation(${reservation.id})">取消</button>`;
          }
        } else {
          return `<span class="text-muted small">不足24h不可取消</span>`;
        }
      }
      
      // 其他状态不显示操作按钮
      return '-';
    }
    
    async function cancelReservation(id) {
      if (!confirm('确定要取消这个预约吗？')) return;
      
      try {
        const res = await fetch(`/api/reservations/${id}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ by: 'student' })
        });
        
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          alert(data.error || '取消失败');
          return;
        }
        
        if (data.pending_confirm) {
          alert('取消申请已提交，等待教练确认');
        } else {
          alert('预约已取消');
        }
        
        loadMyReservations('all');
        loadCancelQuota();
      } catch (error) {
        alert('取消失败');
      }
    }
    
    async function confirmCancelReservation(id) {
      if (!confirm('确定要确认取消这个预约吗？确认后预约将被取消且无法恢复。')) return;
      
      try {
        const res = await fetch(`/api/reservations/${id}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ by: 'student', confirm: true })
        });
        
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          alert(data.error || '确认取消失败');
          return;
        }
        
        alert('预约已成功取消');
        loadMyReservations('all');
        loadCancelQuota();
      } catch (error) {
        alert('确认取消失败');
      }
    }
    
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/';
    }
    
    // 表单提交处理
    document.getElementById('reservationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      createReservation();
    });
    
    // 页面加载时检查登录状态
    window.onload = function() {
      try {
        const userData = localStorage.getItem('userData');
        console.log('本地存储的用户数据:', userData);
        
        studentData = JSON.parse(userData || '{}');
        console.log('解析后的学员数据:', studentData);
        
        if (!studentData.id || studentData.role !== 'student') {
          alert('请先登录');
          window.location.href = '/';
          return;
        }
        
        document.getElementById('userInfo').textContent = `学员：${studentData.real_name}`;
        
        // 设置默认时间（明天9点到10点）
        const tomorrow = new Date(Date.now() + 24 * 3600 * 1000);
        const tomorrowStart = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 9, 0);
        const tomorrowEnd = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 10, 0);
        
        document.getElementById('startTime').value = tomorrowStart.toISOString().slice(0, 16);
        document.getElementById('endTime').value = tomorrowEnd.toISOString().slice(0, 16);
        
        // 加载数据
        console.log('开始加载学员数据，学员ID:', studentData.id);
        loadAccountBalance();
        loadCancelQuota();
        loadApprovedCoaches();
        
        // 确保DOM完全加载后再加载预约
        setTimeout(() => {
          loadMyReservations('all');
        }, 500);
      } catch (error) {
        console.error('页面初始化失败:', error);
        alert('页面加载出错，请刷新重试');
      }
    };
  </script>
</body>
</html>
