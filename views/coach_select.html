<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>选择教练 - 乒乓球培训管理系统</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/student.css">
</head>
<body>
  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">乒乓球培训管理系统</a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text" id="userInfo">学员</span>
        <a class="nav-link" href="/" onclick="logout()">退出</a>
      </div>
    </nav>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="list-group">
          <a href="/student.html" class="list-group-item list-group-item-action">学员首页</a>
          <a href="/coach_select.html" class="list-group-item list-group-item-action active">选择教练</a>
          <a href="/student_reservation.html" class="list-group-item list-group-item-action">课程预约</a>
          <a href="/recharge.html" class="list-group-item list-group-item-action">账户充值</a>
          <a href="/reviews.html" class="list-group-item list-group-item-action">课后评价</a>
          <a href="/tournament.html" class="list-group-item list-group-item-action">月赛报名</a>
          <a href="/messages.html" class="list-group-item list-group-item-action">系统消息</a>
        </div>
      </div>
      
      <div class="col-md-9">
        <!-- 当前教练 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>我的教练</h5>
          </div>
          <div class="card-body">
            <div id="currentCoaches">加载中...</div>
          </div>
        </div>

        <!-- 教练搜索 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>搜索教练</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label>教练姓名</label>
                  <input type="text" class="form-control" id="searchName" placeholder="输入姓名搜索">
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label>性别</label>
                  <select class="form-control" id="searchGender">
                    <option value="">不限</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label>年龄</label>
                  <input type="number" class="form-control" id="searchAge" placeholder="年龄">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label>校区</label>
                  <select class="form-control" id="searchCampus">
                    <option value="">选择校区</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label>&nbsp;</label>
                  <div>
                    <button class="btn btn-primary btn-block" onclick="searchCoaches()">搜索</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-2">
              <button class="btn btn-outline-info" onclick="browseAllCoaches()">浏览全部教练</button>
            </div>
          </div>
        </div>

        <!-- 教练列表 -->
        <div class="card">
          <div class="card-header">
            <h5>教练列表</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped" id="coachTable">
                <thead>
                  <tr>
                    <th>头像</th>
                    <th>姓名</th>
                    <th>性别</th>
                    <th>年龄</th>
                    <th>级别</th>
                    <th>收费</th>
                    <th>获奖成绩</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="coachList">
                  <tr><td colspan="8" class="text-center">请使用上方搜索功能查找教练</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- 教练详情模态框 -->
        <div class="modal fade" id="coachDetailModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">教练详情</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body" id="coachDetailContent">
                <!-- 教练详情内容 -->
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-success" id="selectCoachBtn">选择此教练</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    let studentData = {};
    let currentCoachId = null;
    
    async function loadCurrentCoaches() {
      try {
        const res = await fetch(`/api/student/approved-coaches?student_id=${studentData.id}`);
        const coaches = await res.json();
        
        const container = document.getElementById('currentCoaches');
        if (coaches.length === 0) {
          container.innerHTML = '<p class="text-muted">您还没有选择教练，最多可以选择2位教练</p>';
        } else {
          container.innerHTML = coaches.map(coach => `
            <div class="border rounded p-3 mb-2">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h6>${coach.real_name}</h6>
                  <p class="mb-1 text-muted">收费：￥${coach.hourly_fee}/小时</p>
                </div>
                <div class="col-md-4 text-right">
                  <button class="btn btn-outline-primary btn-sm" onclick="changeCoach(${coach.id})">更换教练</button>
                </div>
              </div>
            </div>
          `).join('') + `<small class="text-muted">已选择 ${coaches.length}/2 位教练</small>`;
        }
      } catch (error) {
        document.getElementById('currentCoaches').innerHTML = '<p class="text-danger">加载失败</p>';
      }
    }
    
    async function loadCampuses() {
      try {
        const res = await fetch('/api/campuses');
        const campuses = await res.json();
        
        const select = document.getElementById('searchCampus');
        select.innerHTML = '<option value="">选择校区</option>' + 
          campuses.map(campus => `<option value="${campus.id}">${campus.name}</option>`).join('');
        
        // 默认选择学员的校区
        if (studentData.campus_id) {
          select.value = studentData.campus_id;
        }
      } catch (error) {
        console.error('加载校区失败:', error);
      }
    }
    
    async function searchCoaches() {
      const name = document.getElementById('searchName').value.trim();
      const gender = document.getElementById('searchGender').value;
      const age = document.getElementById('searchAge').value.trim();
      const campus_id = document.getElementById('searchCampus').value;
      
      // 至少需要一个查询条件
      if (!name && !gender && !age) {
        alert('请至少填写一个查询条件（姓名、性别或年龄）');
        return;
      }
      
      const params = new URLSearchParams();
      if (name) params.set('name', name);
      if (gender) params.set('gender', gender);
      if (age) params.set('age', age);
      if (campus_id) params.set('campus_id', campus_id);
      
      await loadCoaches('/api/coaches?' + params.toString());
    }
    
    async function browseAllCoaches() {
      // 浏览全部教练：不限定校区
      await loadCoaches(`/api/coaches`);
    }
    
    async function loadCoaches(url) {
      try {
        const res = await fetch(url);
        const coaches = await res.json();
        
        const tbody = document.getElementById('coachList');
        if (coaches.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">没有找到符合条件的教练</td></tr>';
          return;
        }
        
        tbody.innerHTML = coaches.map(coach => `
          <tr>
            <td>
              <img src="${coach.avatar_url || '/images/default-avatar.png'}" 
                   class="rounded-circle" width="40" height="40" alt="头像">
            </td>
            <td>${coach.real_name}</td>
            <td>${coach.gender}</td>
            <td>${coach.age || '-'}</td>
            <td>${getLevelText(coach.coach_level)}</td>
            <td>￥${coach.hourly_fee}/小时</td>
            <td>
              <small>${coach.coach_awards ? coach.coach_awards.substring(0, 30) + '...' : '暂无'}</small>
            </td>
            <td>
              <button class="btn btn-sm btn-info" onclick="showCoachDetail(${coach.id}, '${coach.real_name}', '${coach.coach_level}', '${coach.coach_awards || ''}', ${coach.hourly_fee})">
                查看详情
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        document.getElementById('coachList').innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败</td></tr>';
      }
    }
    
    function getLevelText(level) {
      const levels = {
        'junior': '初级教练',
        'middle': '中级教练',
        'senior': '高级教练'
      };
      return levels[level] || level;
    }
    
    function showCoachDetail(coachId, name, level, awards, fee) {
      currentCoachId = coachId;
      document.getElementById('coachDetailContent').innerHTML = `
        <div class="row">
          <div class="col-md-4 text-center">
            <img src="/images/default-avatar.png" class="rounded-circle mb-3" width="120" height="120" alt="教练头像">
          </div>
          <div class="col-md-8">
            <h4>${name}</h4>
            <p><strong>级别：</strong>${getLevelText(level)}</p>
            <p><strong>收费：</strong>￥${fee}/小时</p>
            <p><strong>获奖成绩：</strong></p>
            <div class="border p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
              ${awards || '暂无获奖成绩记录'}
            </div>
          </div>
        </div>
      `;
      $('#coachDetailModal').modal('show');
    }
    
    async function selectCoach() {
      if (!currentCoachId) return;
      
      try {
        const res = await fetch('/api/coach/select', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            coach_id: currentCoachId,
            student_id: studentData.id
          })
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.error || '申请失败');
          return;
        }
        
        alert('申请已提交，请等待教练审核');
        $('#coachDetailModal').modal('hide');
        loadCurrentCoaches();
      } catch (error) {
        alert('申请失败');
      }
    }
    
    async function changeCoach(oldCoachId) {
      const newCoachId = prompt('请输入新教练的ID：');
      if (!newCoachId) return;
      
      try {
        const res = await fetch('/api/coach/change', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: studentData.id,
            old_coach_id: oldCoachId,
            new_coach_id: parseInt(newCoachId)
          })
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.error || '更换申请失败');
          return;
        }
        
        alert('更换申请已提交，需要当前教练、新教练和管理员三方确认');
      } catch (error) {
        alert('更换申请失败');
      }
    }
    
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/';
    }
    
    // 页面加载时检查登录状态
    window.onload = function() {
      studentData = JSON.parse(localStorage.getItem('userData') || '{}');
      if (!studentData.id || studentData.role !== 'student') {
        alert('请先登录');
        window.location.href = '/';
        return;
      }
      
      document.getElementById('userInfo').textContent = `学员：${studentData.real_name}`;
      document.getElementById('selectCoachBtn').onclick = selectCoach;
      
      loadCurrentCoaches();
      loadCampuses();
    };
  </script>
</body>
</html>
