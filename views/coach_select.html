<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€‰æ‹©æ•™ç»ƒ - ä¹’ä¹“çƒåŸ¹è®­ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/student.css">
  <style>
    .coach-selection-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      background-color: #f8f9fa;
      padding: 10px;
    }
    
    .coach-selection-item {
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e9ecef;
      margin-bottom: 8px !important;
    }
    
    .coach-selection-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #007bff;
    }
    
    .coach-selection-item .select-coach-btn {
      min-width: 80px;
      font-size: 0.875rem;
    }
    
    .coach-selection-item .badge {
      font-size: 0.75rem;
    }
    
    #changeCoachModal .modal-dialog {
      max-width: 650px;
    }
    
    .coach-change-reason {
      background-color: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin: 15px 0;
    }
    
    .coach-selection-item .card-body {
      background: white;
      border-radius: 0.25rem;
    }
    
    .coach-selection-item:last-child {
      margin-bottom: 0 !important;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">ä¹’ä¹“çƒåŸ¹è®­ç®¡ç†ç³»ç»Ÿ</a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text" id="userInfo">å­¦å‘˜</span>
        <a class="nav-link" href="/" onclick="logout()">é€€å‡º</a>
      </div>
    </nav>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="list-group">
          <a href="/student.html" class="list-group-item list-group-item-action">å­¦å‘˜é¦–é¡µ</a>
          <a href="/coach_select.html" class="list-group-item list-group-item-action active">é€‰æ‹©æ•™ç»ƒ</a>
          <a href="/student_reservation.html" class="list-group-item list-group-item-action">è¯¾ç¨‹é¢„çº¦</a>
          <a href="/recharge.html" class="list-group-item list-group-item-action">è´¦æˆ·å……å€¼</a>
          <a href="/reviews.html" class="list-group-item list-group-item-action">è¯¾åè¯„ä»·</a>
          <a href="/tournament.html" class="list-group-item list-group-item-action">æœˆèµ›æŠ¥å</a>
          <a href="/messages.html" class="list-group-item list-group-item-action">ç³»ç»Ÿæ¶ˆæ¯</a>
        </div>
      </div>
      
      <div class="col-md-9">
        <!-- å½“å‰æ•™ç»ƒ -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>æˆ‘çš„æ•™ç»ƒ</h5>
          </div>
          <div class="card-body">
            <div id="currentCoaches">åŠ è½½ä¸­...</div>
          </div>
        </div>

        <!-- æ•™ç»ƒæœç´¢ -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>æœç´¢æ•™ç»ƒ</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label>æ•™ç»ƒå§“å</label>
                  <input type="text" class="form-control" id="searchName" placeholder="è¾“å…¥å§“åæœç´¢">
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label>æ€§åˆ«</label>
                  <select class="form-control" id="searchGender">
                    <option value="">ä¸é™</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label>å¹´é¾„</label>
                  <input type="number" class="form-control" id="searchAge" placeholder="å¹´é¾„">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label>æ ¡åŒº</label>
                  <select class="form-control" id="searchCampus">
                    <option value="">é€‰æ‹©æ ¡åŒº</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label>&nbsp;</label>
                  <div>
                    <button class="btn btn-primary btn-block" onclick="searchCoaches()">æœç´¢</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-2">
              <button class="btn btn-outline-info" onclick="browseAllCoaches()">æµè§ˆå…¨éƒ¨æ•™ç»ƒ</button>
            </div>
          </div>
        </div>

        <!-- æ•™ç»ƒåˆ—è¡¨ -->
        <div class="card">
          <div class="card-header">
            <h5>æ•™ç»ƒåˆ—è¡¨</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped" id="coachTable">
                <thead>
                  <tr>
                    <th>å¤´åƒ</th>
                    <th>å§“å</th>
                    <th>æ€§åˆ«</th>
                    <th>å¹´é¾„</th>
                    <th>çº§åˆ«</th>
                    <th>æ”¶è´¹</th>
                    <th>è·å¥–æˆç»©</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="coachList">
                  <tr><td colspan="8" class="text-center">è¯·ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æŸ¥æ‰¾æ•™ç»ƒ</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- æ•™ç»ƒè¯¦æƒ…æ¨¡æ€æ¡† -->
        <div class="modal fade" id="coachDetailModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">æ•™ç»ƒè¯¦æƒ…</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body" id="coachDetailContent">
                <!-- æ•™ç»ƒè¯¦æƒ…å†…å®¹ -->
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-success" id="selectCoachBtn">é€‰æ‹©æ­¤æ•™ç»ƒ</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    let studentData = {};
    let currentCoachId = null;
    
    async function loadCurrentCoaches() {
      try {
        const res = await fetch(`/api/student/approved-coaches?student_id=${studentData.id}`);
        const coaches = await res.json();
        
        const container = document.getElementById('currentCoaches');
        if (coaches.length === 0) {
          container.innerHTML = '<p class="text-muted">æ‚¨è¿˜æ²¡æœ‰é€‰æ‹©æ•™ç»ƒï¼Œæœ€å¤šå¯ä»¥é€‰æ‹©2ä½æ•™ç»ƒ</p>';
        } else {
          container.innerHTML = coaches.map(coach => `
            <div class="border rounded p-3 mb-2">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h6>${coach.real_name}</h6>
                  <p class="mb-1 text-muted">æ”¶è´¹ï¼šï¿¥${coach.hourly_fee}/å°æ—¶</p>
                </div>
                <div class="col-md-4 text-right">
                  <button class="btn btn-outline-primary btn-sm" onclick="changeCoach(${coach.id})">æ›´æ¢æ•™ç»ƒ</button>
                </div>
              </div>
            </div>
          `).join('') + `<small class="text-muted">å·²é€‰æ‹© ${coaches.length}/2 ä½æ•™ç»ƒ</small>`;
        }
      } catch (error) {
        document.getElementById('currentCoaches').innerHTML = '<p class="text-danger">åŠ è½½å¤±è´¥</p>';
      }
    }
    
    async function loadCampuses() {
      try {
        const res = await fetch('/api/campuses');
        const campuses = await res.json();
        
        const select = document.getElementById('searchCampus');
        select.innerHTML = '<option value="">é€‰æ‹©æ ¡åŒº</option>' + 
          campuses.map(campus => `<option value="${campus.id}">${campus.name}</option>`).join('');
        
        // é»˜è®¤é€‰æ‹©å­¦å‘˜çš„æ ¡åŒº
        if (studentData.campus_id) {
          select.value = studentData.campus_id;
        }
      } catch (error) {
        console.error('åŠ è½½æ ¡åŒºå¤±è´¥:', error);
      }
    }
    
    async function searchCoaches() {
      const name = document.getElementById('searchName').value.trim();
      const gender = document.getElementById('searchGender').value;
      const age = document.getElementById('searchAge').value.trim();
      const campus_id = document.getElementById('searchCampus').value;
      
      // è‡³å°‘éœ€è¦ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶
      if (!name && !gender && !age) {
        alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶ï¼ˆå§“åã€æ€§åˆ«æˆ–å¹´é¾„ï¼‰');
        return;
      }
      
      const params = new URLSearchParams();
      if (name) params.set('name', name);
      if (gender) params.set('gender', gender);
      if (age) params.set('age', age);
      if (campus_id) params.set('campus_id', campus_id);
      
      await loadCoaches('/api/coaches?' + params.toString());
    }
    
    async function browseAllCoaches() {
      // æµè§ˆå…¨éƒ¨æ•™ç»ƒï¼šä¸é™å®šæ ¡åŒº
      await loadCoaches(`/api/coaches`);
    }
    
    async function loadCoaches(url) {
      try {
        const res = await fetch(url);
        const coaches = await res.json();
        
        const tbody = document.getElementById('coachList');
        if (coaches.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•™ç»ƒ</td></tr>';
          return;
        }
        
        tbody.innerHTML = coaches.map(coach => `
          <tr>
            <td>
              <img src="${coach.avatar_url || '/images/default-avatar.png'}" 
                   class="rounded-circle" width="40" height="40" alt="å¤´åƒ">
            </td>
            <td>${coach.real_name}</td>
            <td>${coach.gender}</td>
            <td>${coach.age || '-'}</td>
            <td>${getLevelText(coach.coach_level)}</td>
            <td>ï¿¥${coach.hourly_fee}/å°æ—¶</td>
            <td>
              <small>${coach.coach_awards ? coach.coach_awards.substring(0, 30) + '...' : 'æš‚æ— '}</small>
            </td>
            <td>
              <button class="btn btn-sm btn-info" onclick="showCoachDetail(${coach.id}, '${coach.real_name}', '${coach.coach_level}', '${coach.coach_awards || ''}', ${coach.hourly_fee})">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        document.getElementById('coachList').innerHTML = '<tr><td colspan="8" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
      }
    }
    
    function getLevelText(level) {
      const levels = {
        'junior': 'åˆçº§æ•™ç»ƒ',
        'middle': 'ä¸­çº§æ•™ç»ƒ',
        'senior': 'é«˜çº§æ•™ç»ƒ'
      };
      return levels[level] || level;
    }
    
    function showCoachDetail(coachId, name, level, awards, fee) {
      currentCoachId = coachId;
      document.getElementById('coachDetailContent').innerHTML = `
        <div class="row">
          <div class="col-md-4 text-center">
            <img src="/images/default-avatar.png" class="rounded-circle mb-3" width="120" height="120" alt="æ•™ç»ƒå¤´åƒ">
          </div>
          <div class="col-md-8">
            <h4>${name}</h4>
            <p><strong>çº§åˆ«ï¼š</strong>${getLevelText(level)}</p>
            <p><strong>æ”¶è´¹ï¼š</strong>ï¿¥${fee}/å°æ—¶</p>
            <p><strong>è·å¥–æˆç»©ï¼š</strong></p>
            <div class="border p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
              ${awards || 'æš‚æ— è·å¥–æˆç»©è®°å½•'}
            </div>
          </div>
        </div>
      `;
      $('#coachDetailModal').modal('show');
    }
    
    async function selectCoach() {
      if (!currentCoachId) return;
      
      try {
        const res = await fetch('/api/coach/select', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            coach_id: currentCoachId,
            student_id: studentData.id
          })
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.error || 'ç”³è¯·å¤±è´¥');
          return;
        }
        
        alert('ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…æ•™ç»ƒå®¡æ ¸');
        $('#coachDetailModal').modal('hide');
        loadCurrentCoaches();
      } catch (error) {
        alert('ç”³è¯·å¤±è´¥');
      }
    }
    
    async function changeCoach(oldCoachId) {
      // æ˜¾ç¤ºæ•™ç»ƒé€‰æ‹©æ¨¡æ€æ¡†
      await showCoachSelectModal(oldCoachId);
    }
    
    async function showCoachSelectModal(oldCoachId) {
      try {
        // è·å–å¯é€‰æ‹©çš„æ•™ç»ƒåˆ—è¡¨ï¼ˆæ’é™¤å½“å‰æ•™ç»ƒï¼‰
        const res = await fetch(`/api/coaches?campus_id=${studentData.campus_id}`);
        if (!res.ok) {
          alert('è·å–æ•™ç»ƒåˆ—è¡¨å¤±è´¥');
          return;
        }
        
        const coaches = await res.json();
        const availableCoaches = coaches.filter(coach => coach.id !== oldCoachId);
        
        if (availableCoaches.length === 0) {
          alert('æš‚æ— å…¶ä»–æ•™ç»ƒå¯é€‰æ‹©');
          return;
        }
        
        // åˆ›å»ºæ•™ç»ƒé€‰æ‹©æ¨¡æ€æ¡†
        const modalHtml = `
          <div class="modal fade" id="changeCoachModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title">
                    <i class="fas fa-exchange-alt mr-2"></i>æ›´æ¢æ•™ç»ƒ
                  </h5>
                  <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>æ›´æ¢è¯´æ˜ï¼š</strong>æ›´æ¢æ•™ç»ƒç”³è¯·éœ€è¦å½“å‰æ•™ç»ƒã€æ–°æ•™ç»ƒå’Œæ ¡åŒºç®¡ç†å‘˜ä¸‰æ–¹ç¡®è®¤æ‰èƒ½ç”Ÿæ•ˆã€‚
                  </div>
                  
                  <h6 class="mb-3">
                    <i class="fas fa-users mr-2"></i>è¯·é€‰æ‹©æ‚¨è¦æ›´æ¢çš„æ–°æ•™ç»ƒï¼š
                  </h6>
                  <div class="coach-selection-list">
                    ${availableCoaches.map(coach => `
                      <div class="card mb-2 coach-selection-item" data-coach-id="${coach.id}">
                        <div class="card-body py-3">
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                              <div class="d-flex align-items-center mb-2">
                                <strong class="mr-2">${coach.real_name}</strong>
                                <span class="badge badge-info">${coach.coach_level === 'senior' ? 'é«˜çº§æ•™ç»ƒ' : coach.coach_level === 'middle' ? 'ä¸­çº§æ•™ç»ƒ' : coach.coach_level === 'junior' ? 'åˆçº§æ•™ç»ƒ' : 'æœªè®¾ç½®'}</span>
                                <span class="text-muted ml-2">${coach.gender} Â· ${coach.age}å²</span>
                              </div>
                              <div class="text-muted">
                                <small>è¯¾æ—¶è´¹: Â¥${coach.hourly_fee}/å°æ—¶</small>
                                ${coach.coach_awards ? `<br><small class="text-success"><i class="fas fa-trophy"></i> ${coach.coach_awards}</small>` : ''}
                              </div>
                            </div>
                            <button class="btn btn-sm btn-primary select-coach-btn ml-3" 
                                    onclick="selectNewCoach(${oldCoachId}, ${coach.id}, '${coach.real_name}')">
                              é€‰æ‹©æ­¤æ•™ç»ƒ
                            </button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                  <div class="mt-4">
                    <h6>
                      <i class="fas fa-edit mr-2"></i>æ›´æ¢åŸå› ï¼š
                    </h6>
                    <textarea class="form-control" id="changeReason" rows="3" 
                              placeholder="è¯·ç®€è¦è¯´æ˜æ›´æ¢æ•™ç»ƒçš„åŸå› ï¼Œè¿™æœ‰åŠ©äºç®¡ç†å‘˜æ›´å¥½åœ°å¤„ç†æ‚¨çš„ç”³è¯·..."></textarea>
                    <small class="form-text text-muted">
                      <i class="fas fa-lightbulb mr-1"></i>
                      å»ºè®®è¯¦ç»†è¯´æ˜åŸå› ï¼Œå¦‚ï¼šä¸Šè¯¾æ—¶é—´å†²çªã€å­¦ä¹ éœ€æ±‚å˜åŒ–ã€æ•™å­¦é£æ ¼åå¥½ç­‰
                    </small>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>å–æ¶ˆ
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
        $('#changeCoachModal').remove();
        
        // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†åˆ°é¡µé¢
        $('body').append(modalHtml);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        $('#changeCoachModal').modal('show');
        
      } catch (error) {
        console.error('Error:', error);
        alert('è·å–æ•™ç»ƒåˆ—è¡¨å¤±è´¥');
      }
    }
    
    async function selectNewCoach(oldCoachId, newCoachId, newCoachName) {
      const reason = document.getElementById('changeReason').value.trim();
      
      if (!reason) {
        alert('è¯·å¡«å†™æ›´æ¢åŸå› ');
        return;
      }
      
      if (confirm(`ç¡®å®šè¦ç”³è¯·æ›´æ¢åˆ°æ•™ç»ƒ ${newCoachName} å—ï¼Ÿ

ğŸ“ æ›´æ¢åŸå› ï¼š${reason}

âš ï¸ é‡è¦æé†’ï¼š
â€¢ æ›´æ¢ç”³è¯·éœ€è¦å½“å‰æ•™ç»ƒç¡®è®¤åŒæ„
â€¢ æ–°æ•™ç»ƒéœ€è¦ç¡®è®¤æ¥æ”¶æ‚¨ä¸ºå­¦å‘˜  
â€¢ æ ¡åŒºç®¡ç†å‘˜æœ€ç»ˆå®¡æ ¸æ‰¹å‡†
â€¢ ä¸‰æ–¹ç¡®è®¤åæ‰èƒ½æ­£å¼æ›´æ¢

æ˜¯å¦ç»§ç»­æäº¤ç”³è¯·ï¼Ÿ`)) {
        try {
          const res = await fetch('/api/coach/change-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              student_id: studentData.id,
              current_coach_id: oldCoachId,
              new_coach_id: newCoachId,
              reason: reason
            })
          });
          
          const data = await res.json();
          if (!res.ok || !data.success) {
            alert(data.error || 'æ›´æ¢ç”³è¯·å¤±è´¥');
            return;
          }
          
          alert('æ›´æ¢ç”³è¯·å·²æäº¤æˆåŠŸï¼éœ€è¦å½“å‰æ•™ç»ƒã€æ–°æ•™ç»ƒå’Œç®¡ç†å‘˜ä¸‰æ–¹ç¡®è®¤ã€‚');
          $('#changeCoachModal').modal('hide');
          loadCurrentCoaches(); // åˆ·æ–°å½“å‰æ•™ç»ƒåˆ—è¡¨
          
        } catch (error) {
          console.error('Error:', error);
          alert('æ›´æ¢ç”³è¯·å¤±è´¥');
        }
      }
    }
    
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/';
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    window.onload = function() {
      studentData = JSON.parse(localStorage.getItem('userData') || '{}');
      if (!studentData.id || studentData.role !== 'student') {
        alert('è¯·å…ˆç™»å½•');
        window.location.href = '/';
        return;
      }
      
      document.getElementById('userInfo').textContent = `å­¦å‘˜ï¼š${studentData.real_name}`;
      document.getElementById('selectCoachBtn').onclick = selectCoach;
      
      loadCurrentCoaches();
      loadCampuses();
    };
  </script>
</body>
</html>
