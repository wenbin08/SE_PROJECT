<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>账户充值 - 乒乓球培训管理系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <style>
    .payment-card {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .payment-card:hover {
      border-color: #007bff;
      box-shadow: 0 4px 8px rgba(0,123,255,0.15);
    }
    .payment-card.selected {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    .amount-btn {
      width: 100%;
      margin-bottom: 10px;
    }
    .qr-code {
      max-width: 200px;
      margin: 0 auto;
    }
    .balance-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #28a745;
    }
    .transaction-history {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/index.html">
        <i class="bi bi-trophy"></i> 乒乓球培训系统
      </a>
      <div class="navbar-nav ml-auto">
        <a class="nav-link" href="/index.html">
          <i class="bi bi-house"></i> 返回首页
        </a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <!-- 左侧：充值区域 -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-wallet2"></i> 账户充值</h5>
            <small id="userInfo" class="text-light">加载中...</small>
          </div>
          <div class="card-body">
            <!-- 用户信息 -->
            <div class="row mb-4">
              <div class="col-md-6">
                <label for="uid" class="form-label">用户ID</label>
                <input type="number" id="uid" class="form-control" placeholder="自动填充" readonly>
                <small class="text-muted">已自动填充当前登录用户</small>
              </div>
              <div class="col-md-6">
                <label class="form-label">当前余额</label>
                <div class="balance-display" id="bal">点击查询</div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="checkBalance()">
                  <i class="bi bi-arrow-clockwise"></i> 查询余额
                </button>
              </div>
            </div>

            <!-- 充值金额选择 -->
            <div class="mb-4">
              <label class="form-label">选择充值金额</label>
              <div class="row">
                <div class="col-md-3 col-6">
                  <button type="button" class="btn btn-outline-primary amount-btn" onclick="setAmount(100)">
                    ￥100
                  </button>
                </div>
                <div class="col-md-3 col-6">
                  <button type="button" class="btn btn-outline-primary amount-btn" onclick="setAmount(200)">
                    ￥200
                  </button>
                </div>
                <div class="col-md-3 col-6">
                  <button type="button" class="btn btn-outline-primary amount-btn" onclick="setAmount(500)">
                    ￥500
                  </button>
                </div>
                <div class="col-md-3 col-6">
                  <button type="button" class="btn btn-outline-primary amount-btn" onclick="setAmount(1000)">
                    ￥1000
                  </button>
                </div>
              </div>
              <div class="mt-3">
                <label for="customAmount" class="form-label">自定义金额</label>
                <input type="number" id="customAmount" class="form-control" min="1" max="10000" placeholder="请输入充值金额">
              </div>
            </div>

            <!-- 支付方式选择 -->
            <div class="mb-4">
              <label class="form-label">选择支付方式</label>
              <div class="row">
                <div class="col-md-4">
                  <div class="payment-card p-3 text-center" onclick="selectPayment('wechat')">
                    <i class="bi bi-wechat text-success" style="font-size: 2rem;"></i>
                    <div class="mt-2">微信支付</div>
                    <small class="text-muted">扫码支付</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="payment-card p-3 text-center" onclick="selectPayment('alipay')">
                    <i class="bi bi-alipay text-primary" style="font-size: 2rem;"></i>
                    <div class="mt-2">支付宝</div>
                    <small class="text-muted">扫码支付</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="payment-card p-3 text-center" onclick="selectPayment('offline')">
                    <i class="bi bi-cash text-warning" style="font-size: 2rem;"></i>
                    <div class="mt-2">线下支付</div>
                    <small class="text-muted">现金/刷卡</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- 充值按钮 -->
            <div class="text-center">
              <button type="button" class="btn btn-primary btn-lg" onclick="recharge()" id="rechargeBtn" disabled>
                <i class="bi bi-credit-card"></i> 立即充值
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧：账户信息和交易记录 -->
      <div class="col-lg-4">
        <div class="card mb-3">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-info-circle"></i> 充值说明</h6>
          </div>
          <div class="card-body">
            <ul class="list-unstyled mb-0">
              <li><i class="bi bi-check-circle text-success"></i> 充值金额实时到账</li>
              <li><i class="bi bi-check-circle text-success"></i> 支持多种支付方式</li>
              <li><i class="bi bi-check-circle text-success"></i> 单次充值限额：￥1-10000</li>
              <li><i class="bi bi-check-circle text-success"></i> 余额可用于预约课程</li>
              <li><i class="bi bi-check-circle text-success"></i> 退余额请联系客服</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-clock-history"></i> 充值记录</h6>
          </div>
          <div class="card-body p-0">
            <div class="transaction-history" id="transactionHistory">
              <div class="text-center p-3 text-muted">
                暂无充值记录
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 支付二维码模态框 -->
  <div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrModalTitle">扫码支付</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body text-center">
          <div class="qr-code mb-3">
            <div class="border p-4" style="width: 200px; height: 200px; margin: 0 auto; background: #f8f9fa;">
              <i class="bi bi-qr-code" style="font-size: 8rem; color: #6c757d;"></i>
            </div>
          </div>
          <p class="text-muted">请使用相应APP扫描二维码完成支付</p>
          <div class="alert alert-info">
            <strong>支付金额：</strong>￥<span id="payAmount">0</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">取消支付</button>
          <button type="button" class="btn btn-success" onclick="confirmPayment()">支付完成</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let selectedPayment = null;
    let selectedAmount = 0;

    // 检查登录状态
    function checkAuth() {
      const userData = localStorage.getItem('userData');
      if (!userData) {
        alert('请先登录');
        window.location.href = '/index.html';
        return false;
      }
      
      const user = JSON.parse(userData);
      
      // 自动填充当前登录用户的ID，并设为只读
      document.getElementById('uid').value = user.id;
      document.getElementById('uid').readOnly = true;
      
      // 显示用户信息
      document.getElementById('userInfo').textContent = `当前用户: ${user.real_name || user.username} (${user.role})`;
      
      return true;
    }

    // 查询余额
    async function checkBalance() {
      const uid = document.getElementById('uid').value;
      if (!uid) {
        alert('请输入用户ID');
        return;
      }

      try {
        const res = await fetch(`/api/account/${uid}`);
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || '查询失败');
        }

        document.getElementById('bal').textContent = '￥' + (data.balance || 0).toFixed(2);
        loadTransactionHistory(uid);
      } catch (error) {
        document.getElementById('bal').textContent = '查询失败';
        alert('查询余额失败：' + error.message);
      }
    }

    // 设置充值金额
    function setAmount(amount) {
      selectedAmount = amount;
      document.getElementById('customAmount').value = amount;
      updateRechargeButton();
      
      // 更新按钮样式
      document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
      });
      event.target.classList.remove('btn-outline-primary');
      event.target.classList.add('btn-primary');
    }

    // 监听自定义金额输入
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('customAmount').addEventListener('input', function() {
        selectedAmount = parseFloat(this.value) || 0;
        updateRechargeButton();
        
        // 重置预设金额按钮样式
        document.querySelectorAll('.amount-btn').forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline-primary');
        });
      });
    });

    // 选择支付方式
    function selectPayment(method) {
      selectedPayment = method;
      
      // 更新支付卡片样式
      document.querySelectorAll('.payment-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      
      updateRechargeButton();
    }

    // 更新充值按钮状态
    function updateRechargeButton() {
      const btn = document.getElementById('rechargeBtn');
      const uid = document.getElementById('uid').value;
      
      if (uid && selectedAmount > 0 && selectedPayment) {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-credit-card"></i> 充值 ￥${selectedAmount}`;
      } else {
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-credit-card"></i> 立即充值';
      }
    }

    // 执行充值
    async function recharge() {
      const uid = document.getElementById('uid').value;
      const amount = selectedAmount;
      
      if (!uid || !amount || !selectedPayment) {
        alert('请完整填写充值信息');
        return;
      }

      if (amount < 1 || amount > 10000) {
        alert('充值金额必须在1-10000元之间');
        return;
      }

      // 如果是扫码支付，显示二维码
      if (selectedPayment === 'wechat' || selectedPayment === 'alipay') {
        showQRCode(selectedPayment, amount);
        return;
      }

      // 线下支付直接处理
      await processRecharge(uid, amount, selectedPayment);
    }

    // 显示二维码
    function showQRCode(method, amount) {
      const title = method === 'wechat' ? '微信支付' : '支付宝支付';
      document.getElementById('qrModalTitle').textContent = title;
      document.getElementById('payAmount').textContent = amount;
      $('#qrModal').modal('show');
    }

    // 确认支付完成
    async function confirmPayment() {
      const uid = document.getElementById('uid').value;
      await processRecharge(uid, selectedAmount, selectedPayment);
      $('#qrModal').modal('hide');
    }

    // 处理充值
    async function processRecharge(uid, amount, method) {
      try {
        const res = await fetch('/api/account/recharge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: parseInt(uid),
            amount: amount,
            method: method
          })
        });

        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || '充值失败');
        }

        alert('充值成功！');
        await checkBalance();
        
        // 重置表单
        selectedAmount = 0;
        selectedPayment = null;
        document.getElementById('customAmount').value = '';
        document.querySelectorAll('.amount-btn').forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline-primary');
        });
        document.querySelectorAll('.payment-card').forEach(card => {
          card.classList.remove('selected');
        });
        updateRechargeButton();
        
      } catch (error) {
        alert('充值失败：' + error.message);
      }
    }

    // 加载交易记录
    async function loadTransactionHistory(uid) {
      try {
        const res = await fetch(`/api/account/transactions/${uid}`);
        const data = await res.json();
        
        const container = document.getElementById('transactionHistory');
        
        if (!res.ok || !data.transactions || data.transactions.length === 0) {
          container.innerHTML = '<div class="text-center p-3 text-muted">暂无充值记录</div>';
          return;
        }

        const html = data.transactions.map(transaction => `
          <div class="border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong class="text-success">+￥${transaction.amount}</strong>
                <small class="d-block text-muted">${transaction.method === 'wechat' ? '微信支付' : transaction.method === 'alipay' ? '支付宝' : '线下支付'}</small>
              </div>
              <small class="text-muted">${new Date(transaction.created_at).toLocaleString()}</small>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('加载交易记录失败:', error);
      }
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAuth()) {
        checkBalance();
      }
    });
  </script>
</body>
</html>
