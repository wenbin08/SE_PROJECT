<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>校区管理员 - 乒乓球培训管理系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">乒乓球培训管理系统</a>
      <div class="navbar-nav ml-auto">
        <span class="navbar-text" id="userInfo">校区管理员</span>
        <a class="nav-link" href="/" onclick="logout()">退出</a>
      </div>
    </nav>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="list-group">
          <a href="/campus_admin.html" class="list-group-item list-group-item-action active">管理首页</a>
          <a href="/admin_approve.html" class="list-group-item list-group-item-action">教练审核</a>
          <a href="/admin_users.html" class="list-group-item list-group-item-action">用户管理</a>
          <a href="/admin_reservations.html" class="list-group-item list-group-item-action">预约管理</a>
          <a href="#coachChangeAdmin" class="list-group-item list-group-item-action" data-toggle="tab">更换申请</a>
          <a href="/admin_tournament.html" class="list-group-item list-group-item-action">月赛管理</a>
          <a href="/admin_finance.html" class="list-group-item list-group-item-action">财务管理</a>
          <a href="/admin_statistics.html" class="list-group-item list-group-item-action">统计报表</a>
        </div>
      </div>
      
      <div class="col-md-9">
        <!-- 统计卡片 -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card text-white bg-primary">
              <div class="card-body">
                <h5 class="card-title">学员总数</h5>
                <h2 id="studentCount">-</h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-success">
              <div class="card-body">
                <h5 class="card-title">教练总数</h5>
                <h2 id="coachCount">-</h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-warning">
              <div class="card-body">
                <h5 class="card-title">待审核教练</h5>
                <h2 id="pendingCount">-</h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-info">
              <div class="card-body">
                <h5 class="card-title">今日预约</h5>
                <h2 id="todayReservations">-</h2>
              </div>
            </div>
          </div>
        </div>

        <!-- 快速操作 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>快速操作</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>充值管理</h6>
                <form id="rechargeForm" class="mb-3">
                  <div class="form-row">
                    <div class="col-5">
                      <input type="text" class="form-control" id="rechargeUserId" placeholder="用户ID">
                    </div>
                    <div class="col-4">
                      <input type="number" class="form-control" id="rechargeAmount" placeholder="金额" step="0.01">
                    </div>
                    <div class="col-3">
                      <button type="submit" class="btn btn-primary btn-block">充值</button>
                    </div>
                  </div>
                </form>
              </div>
              <div class="col-md-6">
                <h6>球台管理</h6>
                <form id="addTableForm" class="mb-3">
                  <div class="form-row">
                    <div class="col-6">
                      <input type="text" class="form-control" id="tableCode" placeholder="球台编号">
                    </div>
                    <div class="col-6">
                      <button type="submit" class="btn btn-success btn-block">添加球台</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- 更换申请管理 -->
        <div class="tab-pane fade" id="coachChangeAdmin" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h5>教练更换申请管理</h5>
              <button class="btn btn-sm btn-outline-primary" onclick="loadCoachChangeRequestsAdmin()">刷新</button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>申请ID</th>
                      <th>学员姓名</th>
                      <th>当前教练</th>
                      <th>目标教练</th>
                      <th>申请原因</th>
                      <th>当前教练</th>
                      <th>目标教练</th>
                      <th>状态</th>
                      <th>申请时间</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="coachChangeAdminList">
                    <tr><td colspan="10" class="text-center">加载中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 最新消息和日志 -->
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>最新系统消息</h5>
              </div>
              <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="recentMessages">加载中...</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>最新操作日志</h5>
              </div>
              <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="recentLogs">加载中...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    let adminData = {};
    
    async function loadStatistics() {
      try {
        const res = await fetch(`/api/admin/statistics?campus_id=${adminData.campus_id}`);
        const stats = await res.json();
        
        // 确保 stats.users 存在，并提供默认值
        const users = stats.users || {};
        document.getElementById('studentCount').textContent = users.student || 0;
        document.getElementById('coachCount').textContent = users.coach || 0;
        document.getElementById('pendingCount').textContent = await getPendingCount();
        document.getElementById('todayReservations').textContent = await getTodayReservations();
      } catch (error) {
        console.error('加载统计数据失败:', error);
      }
    }
    
    async function getPendingCount() {
      try {
        const res = await fetch(`/api/campus/coach/pending?campus_id=${adminData.campus_id}`);
        const pending = await res.json();
        return pending.length;
      } catch (error) {
        return 0;
      }
    }
    
    async function getTodayReservations() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`/api/reservations?campus_id=${adminData.campus_id}&from=${today} 00:00:00&to=${today} 23:59:59`);
        const reservations = await res.json();
        return reservations.length;
      } catch (error) {
        return 0;
      }
    }
    
    async function loadRecentMessages() {
      try {
        const res = await fetch(`/api/messages?recipient_id=${adminData.id}`);
        const messages = await res.json();
        
        const messageHtml = messages.slice(0, 5).map(msg => `
          <div class="border-bottom pb-2 mb-2">
            <div class="d-flex justify-content-between">
              <strong>${msg.title}</strong>
              <small class="text-muted">${new Date(msg.created_at).toLocaleDateString()}</small>
            </div>
            <p class="mb-0 text-truncate">${msg.content}</p>
          </div>
        `).join('') || '<p class="text-muted">暂无消息</p>';
        
        document.getElementById('recentMessages').innerHTML = messageHtml;
      } catch (error) {
        document.getElementById('recentMessages').innerHTML = '<p class="text-danger">加载失败</p>';
      }
    }
    
    async function loadRecentLogs() {
      try {
        const res = await fetch(`/api/admin/audit-log?limit=10`);
        const logs = await res.json();
        
        const logHtml = logs.slice(0, 5).map(log => `
          <div class="border-bottom pb-2 mb-2">
            <div class="d-flex justify-content-between">
              <code class="text-primary">${log.action}</code>
              <small class="text-muted">${new Date(log.created_at).toLocaleString()}</small>
            </div>
            <p class="mb-0 small">${log.details || '无详细信息'}</p>
          </div>
        `).join('') || '<p class="text-muted">暂无日志</p>';
        
        document.getElementById('recentLogs').innerHTML = logHtml;
      } catch (error) {
        document.getElementById('recentLogs').innerHTML = '<p class="text-danger">加载失败</p>';
      }
    }
    
    // 充值表单处理
    document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const userId = document.getElementById('rechargeUserId').value;
      const amount = parseFloat(document.getElementById('rechargeAmount').value);
      
      if (!userId || !amount || amount <= 0) {
        alert('请输入有效的用户ID和金额');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/recharge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            amount: amount,
            admin_id: adminData.id
          })
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.error || '充值失败');
          return;
        }
        
        alert('充值成功');
        document.getElementById('rechargeForm').reset();
      } catch (error) {
        alert('充值失败');
      }
    });
    
    // 添加球台表单处理
    document.getElementById('addTableForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const code = document.getElementById('tableCode').value.trim();
      
      if (!code) {
        alert('请输入球台编号');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/table', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            campus_id: adminData.campus_id,
            code: code
          })
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.error || '添加失败');
          return;
        }
        
        alert('球台添加成功');
        document.getElementById('addTableForm').reset();
      } catch (error) {
        alert('添加失败');
      }
    });
    
    // 加载教练更换申请（管理员）
    async function loadCoachChangeRequestsAdmin() {
      try {
        const res = await fetch(`/api/coach-change-requests?user_id=${adminData.id}&user_role=campus_admin`);
        const requests = await res.json();
        
        const tbody = document.getElementById('coachChangeAdminList');
        if (requests.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="text-center">暂无更换申请</td></tr>';
          return;
        }
        
        tbody.innerHTML = requests.map(req => {
          const statusMap = {
            'pending': '待处理',
            'current_coach_approved': '当前教练已同意',
            'new_coach_approved': '新教练已同意',
            'admin_approved': '管理员已审核',
            'rejected': '已拒绝'
          };
          
          const canApprove = req.status === 'current_coach_approved' || req.status === 'new_coach_approved';
          
          return `
            <tr>
              <td>${req.id}</td>
              <td>${req.student_name}</td>
              <td>${req.current_coach_name}</td>
              <td>${req.new_coach_name}</td>
              <td title="${req.reason}">${req.reason ? req.reason.substring(0, 15) + '...' : '无'}</td>
              <td><span class="badge ${req.current_coach_response ? 'badge-success' : 'badge-secondary'}">${req.current_coach_response ? '已响应' : '待响应'}</span></td>
              <td><span class="badge ${req.new_coach_response ? 'badge-success' : 'badge-secondary'}">${req.new_coach_response ? '已响应' : '待响应'}</span></td>
              <td><span class="badge ${req.status === 'pending' ? 'badge-warning' : req.status === 'rejected' ? 'badge-danger' : 'badge-info'}">${statusMap[req.status] || req.status}</span></td>
              <td>${new Date(req.created_at).toLocaleString()}</td>
              <td>
                ${canApprove ? `
                  <button class="btn btn-sm btn-success" onclick="adminApproveChangeRequest(${req.id}, true)">最终批准</button>
                  <button class="btn btn-sm btn-danger ml-1" onclick="adminApproveChangeRequest(${req.id}, false)">拒绝</button>
                ` : req.status === 'admin_approved' ? '已处理' : '等待教练响应'}
                <button class="btn btn-sm btn-info ml-1" onclick="viewChangeRequestDetails(${req.id})">详情</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('coachChangeAdminList').innerHTML = '<tr><td colspan="10" class="text-center text-danger">加载失败</td></tr>';
      }
    }

    // 管理员最终审核更换申请
    async function adminApproveChangeRequest(requestId, approve) {
      const response = prompt(approve ? '请输入批准理由（可选）：' : '请输入拒绝原因：');
      if (!approve && !response) {
        alert('拒绝时必须填写原因');
        return;
      }
      
      try {
        const res = await fetch(`/api/coach-change-request/${requestId}/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: adminData.id,
            user_type: 'admin',
            approve: approve,
            response_text: response || ''
          })
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.error || '操作失败');
          return;
        }
        
        alert(approve ? '已批准更换申请' : '已拒绝更换申请');
        loadCoachChangeRequestsAdmin();
      } catch (error) {
        console.error('Error:', error);
        alert('操作失败');
      }
    }

    // 查看更换申请详情
    async function viewChangeRequestDetails(requestId) {
      try {
        const res = await fetch(`/api/coach-change-requests?user_id=${adminData.id}&user_role=campus_admin`);
        const requests = await res.json();
        const req = requests.find(r => r.id === requestId);
        
        if (!req) {
          alert('申请详情不存在');
          return;
        }
        
        const details = `
申请详情：
申请ID: ${req.id}
学员: ${req.student_name}
当前教练: ${req.current_coach_name}
目标教练: ${req.new_coach_name}
申请原因: ${req.reason || '无'}
当前教练响应: ${req.current_coach_response || '无'}
目标教练响应: ${req.new_coach_response || '无'}
管理员响应: ${req.admin_response || '无'}
申请时间: ${new Date(req.created_at).toLocaleString()}
        `;
        
        alert(details);
      } catch (error) {
        alert('获取详情失败');
      }
    }
    
    // 初始化标签页切换
    function initTabSwitching() {
      const tabLinks = document.querySelectorAll('[data-toggle="tab"]');
      tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // 隐藏所有标签页内容
          document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.style.display = 'none';
            pane.classList.remove('show', 'active');
          });
          
          // 移除所有active类
          document.querySelectorAll('.list-group-item-action').forEach(item => {
            item.classList.remove('active');
          });
          
          // 添加active类到当前链接
          this.classList.add('active');
          
          // 显示对应的标签页内容
          const targetId = this.getAttribute('href').substring(1);
          const targetPane = document.getElementById(targetId);
          if (targetPane) {
            targetPane.style.display = 'block';
            targetPane.classList.add('show', 'active');
            
            // 加载对应数据
            if (targetId === 'coachChangeAdmin') {
              loadCoachChangeRequestsAdmin();
            }
          }
        });
      });
    }
    
    function logout() {
      localStorage.removeItem('userData');
      window.location.href = '/';
    }
    
    // 页面加载时检查登录状态
    window.onload = function() {
      adminData = JSON.parse(localStorage.getItem('userData') || '{}');
      if (!adminData.id || adminData.role !== 'campus_admin') {
        alert('请先登录');
        window.location.href = '/';
        return;
      }
      
      document.getElementById('userInfo').textContent = `校区管理员：${adminData.real_name}`;
      
      // 初始化标签页切换
      initTabSwitching();
      
      // 加载数据
      loadStatistics();
      loadRecentMessages();
      loadRecentLogs();
    };
  </script>
</body>
</html>
